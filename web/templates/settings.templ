package templates

import (
	"fmt"
	"strings"

	"github.com/sydlexius/stillwater/internal/connection"
	"github.com/sydlexius/stillwater/internal/library"
	"github.com/sydlexius/stillwater/internal/platform"
	"github.com/sydlexius/stillwater/internal/provider"
	"github.com/sydlexius/stillwater/internal/rule"
	"github.com/sydlexius/stillwater/internal/webhook"
	"github.com/sydlexius/stillwater/web/components"
)

// joinNames joins a string slice with ", " for display.
func joinNames(names []string) string {
	return strings.Join(names, ", ")
}

// profileEditable returns true if the profile's image naming should be editable.
// The seeded "custom" profile and all user-created profiles are editable;
// other builtin profiles (emby, jellyfin, kodi, plex) are read-only.
func profileEditable(p *platform.Profile) bool {
	if p == nil {
		return false
	}
	return !p.IsBuiltin || p.ID == "custom"
}

// SettingsData holds the data for the settings page.
type SettingsData struct {
	ActiveTab            string
	Libraries            []library.Library
	Profiles             []platform.Profile
	ActiveProfile        *platform.Profile
	ProviderKeys         []provider.ProviderKeyStatus
	Priorities           []provider.FieldPriority
	Connections          []connection.Connection
	Webhooks             []webhook.Webhook
	WebSearchProviders   []provider.WebSearchProviderStatus
	AutoFetchImages      bool
	Rules                []rule.Rule
	BadgeEnabled         bool
	BadgeSeverityError   bool
	BadgeSeverityWarning bool
	BadgeSeverityInfo    bool
	RuleScheduleHours    int
}

// settingsTab defines a tab in the settings page navigation.
type settingsTab struct {
	ID    string
	Label string
}

// settingsTabs returns the ordered list of settings page tabs.
func settingsTabs() []settingsTab {
	return []settingsTab{
		{ID: "general", Label: "General"},
		{ID: "providers", Label: "Providers"},
		{ID: "connections", Label: "Connections"},
		{ID: "libraries", Label: "Libraries"},
		{ID: "automation", Label: "Automation"},
		{ID: "rules", Label: "Rules"},
		{ID: "maintenance", Label: "Maintenance"},
	}
}

// rulesForCategory filters rules by category.
func rulesForCategory(rules []rule.Rule, category string) []rule.Rule {
	var result []rule.Rule
	for _, r := range rules {
		if r.Category == category {
			result = append(result, r)
		}
	}
	return result
}

// categoryLabel returns a human-readable label for a rule category.
func categoryLabel(category string) string {
	switch category {
	case "nfo":
		return "NFO"
	case "image":
		return "Images"
	case "metadata":
		return "Metadata"
	default:
		return category
	}
}

// ruleToggleBtnClasses returns CSS classes for the enabled/disabled toggle button.
func ruleToggleBtnClasses(enabled bool) string {
	base := "relative inline-flex h-6 w-11 shrink-0 cursor-pointer rounded-full border-2 border-transparent transition-colors duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 dark:focus:ring-offset-gray-800"
	if enabled {
		return base + " bg-blue-600"
	}
	return base + " bg-gray-200 dark:bg-gray-600"
}

// ruleToggleKnobClasses returns CSS classes for the toggle knob span.
func ruleToggleKnobClasses(enabled bool) string {
	base := "pointer-events-none inline-block h-5 w-5 transform rounded-full bg-white shadow ring-0 transition duration-200 ease-in-out"
	if enabled {
		return base + " translate-x-5"
	}
	return base + " translate-x-0"
}

// severityBadgeClasses returns Tailwind CSS classes for a severity badge.
func severityBadgeClasses(severity string) string {
	switch severity {
	case "error":
		return "bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-300"
	case "warning":
		return "bg-yellow-100 dark:bg-yellow-900/30 text-yellow-700 dark:text-yellow-300"
	default:
		return "bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300"
	}
}

// ruleHasConfig returns true if the rule has user-configurable parameters.
func ruleHasConfig(id string) bool {
	switch id {
	case "thumb_min_res", "thumb_square", "fanart_min_res", "fanart_aspect",
		"logo_min_res", "banner_min_res", "bio_exists":
		return true
	}
	return false
}

// intOrDefault formats an int for use in an HTML input value, using def when v is zero.
func intOrDefault(v, def int) string {
	if v == 0 {
		return fmt.Sprintf("%d", def)
	}
	return fmt.Sprintf("%d", v)
}

// floatOrDefault formats a float64 for use in an HTML input value, using def when v is zero.
func floatOrDefault(v, def float64) string {
	val := v
	if val == 0 {
		val = def
	}
	return fmt.Sprintf("%g", val)
}

// defaultMinWidth returns the default minimum width for a given rule.
func defaultMinWidth(id string) int {
	switch id {
	case "thumb_min_res":
		return 500
	case "fanart_min_res":
		return 1920
	case "logo_min_res":
		return 400
	case "banner_min_res":
		return 1000
	}
	return 0
}

// defaultMinHeight returns the default minimum height for a given rule.
func defaultMinHeight(id string) int {
	switch id {
	case "thumb_min_res":
		return 500
	case "fanart_min_res":
		return 1080
	case "banner_min_res":
		return 185
	}
	return 0
}

// defaultAspectRatio returns the default aspect ratio for a given rule.
func defaultAspectRatio(id string) float64 {
	switch id {
	case "thumb_square":
		return 1.0
	case "fanart_aspect":
		return 16.0 / 9.0
	}
	return 1.0
}

// floatNear returns true if a and b are within 0.001 of each other.
func floatNear(a, b float64) bool {
	d := a - b
	if d < 0 {
		d = -d
	}
	return d < 0.001
}

// fanartResPresetKey returns the preset key matching the given fanart resolution,
// defaulting to 1080p when both values are zero.
func fanartResPresetKey(w, h int) string {
	if w == 0 {
		w = 1920
	}
	if h == 0 {
		h = 1080
	}
	switch {
	case w == 1280 && h == 720:
		return "720p"
	case w == 1920 && h == 1080:
		return "1080p"
	case w == 2560 && h == 1440:
		return "1440p"
	case w == 3840 && h == 2160:
		return "4k"
	}
	return "custom"
}

// thumbResPresetKey returns the preset key for a thumbnail resolution.
func thumbResPresetKey(w, h int) string {
	if w == 0 {
		w = 500
	}
	if h == 0 {
		h = 500
	}
	switch {
	case w == 500 && h == 500:
		return "std"
	case w == 1000 && h == 1000:
		return "hd"
	case w == 2000 && h == 2000:
		return "ultra"
	}
	return "custom"
}

// logoWidthPresetKey returns the preset key for a logo minimum width.
func logoWidthPresetKey(w int) string {
	if w == 0 {
		w = 400
	}
	switch w {
	case 400:
		return "std"
	case 800:
		return "large"
	}
	return "custom"
}

// bannerResPresetKey returns the preset key for a banner resolution.
func bannerResPresetKey(w, h int) string {
	if w == 0 {
		w = 1000
	}
	if h == 0 {
		h = 185
	}
	switch {
	case w == 758 && h == 140:
		return "kodi"
	case w == 1000 && h == 185:
		return "wide"
	}
	return "custom"
}

// fanartAspectPresetKey returns the preset key for a fanart aspect ratio.
func fanartAspectPresetKey(ratio float64) string {
	if ratio == 0 {
		ratio = 16.0 / 9.0
	}
	switch {
	case floatNear(ratio, 16.0/9.0):
		return "16:9"
	case floatNear(ratio, 1.6):
		return "16:10"
	case floatNear(ratio, 2.0):
		return "2:1"
	}
	return "custom"
}

// thumbAspectPresetKey returns the preset key for a thumbnail aspect ratio.
func thumbAspectPresetKey(ratio float64) string {
	if ratio == 0 {
		ratio = 1.0
	}
	if floatNear(ratio, 1.0) {
		return "1:1"
	}
	return "custom"
}

// providerIsAvailable returns true if a provider has a key configured or does not require one.
func providerIsAvailable(name provider.ProviderName, keys []provider.ProviderKeyStatus) bool {
	for _, k := range keys {
		if k.Name == name {
			return k.Status != "unconfigured"
		}
	}
	// Web search providers are not in the key list; check separately.
	if isWebSearchProvider(name) {
		return true
	}
	return false
}

// availableProviders filters a priority list to only providers that are configured.
func availableProviders(pri provider.FieldPriority, keys []provider.ProviderKeyStatus) []provider.ProviderName {
	var result []provider.ProviderName
	for _, p := range pri.Providers {
		if providerIsAvailable(p, keys) {
			result = append(result, p)
		}
	}
	return result
}

// providerIsDisabled returns true if a provider is in the field's disabled list.
func providerIsDisabled(name provider.ProviderName, disabled []provider.ProviderName) bool {
	for _, d := range disabled {
		if d == name {
			return true
		}
	}
	return false
}


// connectionsForType filters connections by type.
func connectionsForType(conns []connection.Connection, connType string) []connection.Connection {
	var result []connection.Connection
	for _, c := range conns {
		if c.Type == connType {
			result = append(result, c)
		}
	}
	return result
}

// hasOKConnection returns true if any connection in the slice has status "ok".
func hasOKConnection(conns []connection.Connection) bool {
	for _, c := range conns {
		if c.Status == "ok" {
			return true
		}
	}
	return false
}

// webSearchToggleJSON generates the JSON body for a web search toggle request.
func webSearchToggleJSON(enabled bool) string {
	if enabled {
		return `{"enabled":true}`
	}
	return `{"enabled":false}`
}

// isWebSearchProvider returns true if the provider is a web search provider.
func isWebSearchProvider(name provider.ProviderName) bool {
	for _, n := range provider.AllWebSearchProviderNames() {
		if n == name {
			return true
		}
	}
	return false
}

templ SettingsPage(assets AssetPaths, data SettingsData) {
	@Layout("Settings", assets) {
		@resetConfirmPrefsScript()
		@settingsTabScript()
		@autoFetchToggleScript()
		@settingsLibraryScript()
		@settingsConnectionScript()
		@connectionFeatureToggleScript()
		@ruleToggleScript()
		@maintenanceScript()
		@settingsExportScript()
		@profileNamingEditorScript()
		<script src={ assets.SortableJS }></script>
		<div class="space-y-6">
			<div class="sw-card rounded-lg px-6 py-4">
				<h1 class="text-2xl font-bold">Settings</h1>
				<p class="mt-1 text-sm text-gray-500 dark:text-gray-400">
					Configure platform profiles, provider API keys, and output settings.
				</p>
			</div>
			@settingsTabBar(data.ActiveTab)
			<!-- General tab -->
			<div
				data-tab-panel="general"
				class={
					"space-y-6",
					templ.KV("hidden", data.ActiveTab != "general"),
				}
			>
				<div class="sw-card bg-white dark:bg-gray-800 shadow rounded-lg">
					<div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
						<h2 class="text-lg font-semibold">Platform Profile</h2>
						<p class="mt-1 text-sm text-gray-500 dark:text-gray-400">
							Select the target platform to control NFO output and image naming conventions.
						</p>
					</div>
					<div class="px-6 py-4">
						<div class="grid grid-cols-1 gap-4 sm:grid-cols-2 lg:grid-cols-3">
							for _, p := range data.Profiles {
								@profileCard(p)
							}
						</div>
					</div>
				</div>
				if data.ActiveProfile != nil {
					<div class="sw-card bg-white dark:bg-gray-800 shadow rounded-lg">
						<div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
							<h2 class="text-lg font-semibold">Active Profile Details</h2>
							if profileEditable(data.ActiveProfile) {
								<p class="mt-1 text-sm text-gray-500 dark:text-gray-400">
									Edit filenames for each image type. Changes are saved to the profile.
								</p>
							}
						</div>
						<div class="px-6 py-4 space-y-4">
							<div class="grid grid-cols-1 gap-4 text-sm sm:grid-cols-2">
								<div>
									<span class="font-medium text-gray-500 dark:text-gray-400">NFO Output</span>
									<p class="mt-1">
										if data.ActiveProfile.NFOEnabled {
											Enabled ({ data.ActiveProfile.NFOFormat } format)
										} else {
											Disabled
										}
									</p>
								</div>
								@profileNamingRow("Thumbnail", "thumb", data.ActiveProfile.ImageNaming.Thumb, !profileEditable(data.ActiveProfile))
								@profileNamingRow("Fanart", "fanart", data.ActiveProfile.ImageNaming.Fanart, !profileEditable(data.ActiveProfile))
								@profileNamingRow("Logo", "logo", data.ActiveProfile.ImageNaming.Logo, !profileEditable(data.ActiveProfile))
								@profileNamingRow("Banner", "banner", data.ActiveProfile.ImageNaming.Banner, !profileEditable(data.ActiveProfile))
							</div>
							if profileEditable(data.ActiveProfile) {
								<div class="pt-2">
									<button
										type="button"
										onclick="saveProfileNaming(this)"
										data-profile-id={ data.ActiveProfile.ID }
										class="inline-flex items-center rounded-md bg-blue-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-blue-500 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-blue-600"
									>
										Save Filenames
									</button>
									<span id="naming-save-status" class="ml-3 text-sm text-gray-500 dark:text-gray-400"></span>
								</div>
							}
						</div>
					</div>
				}
				<div class="sw-card bg-white dark:bg-gray-800 shadow rounded-lg">
					<div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
						<h2 class="text-lg font-semibold">Behavior</h2>
						<p class="mt-1 text-sm text-gray-500 dark:text-gray-400">
							Configure default behaviors for image management and metadata workflows.
						</p>
					</div>
					<div class="px-6 py-4">
						<div class="flex items-center justify-between">
							<div>
								<div class="font-medium text-sm">Auto-fetch images</div>
								<div class="text-xs text-gray-500 dark:text-gray-400 mt-0.5">
									Automatically search providers for images when opening the image management page.
								</div>
							</div>
							<button
								type="button"
								id="auto-fetch-toggle"
								class={
									"relative inline-flex h-6 w-11 shrink-0 cursor-pointer rounded-full border-2 border-transparent transition-colors duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 dark:focus:ring-offset-gray-800",
									templ.KV("bg-blue-600", data.AutoFetchImages),
									templ.KV("bg-gray-200 dark:bg-gray-600", !data.AutoFetchImages),
								}
								role="switch"
								aria-checked={ boolAttr(data.AutoFetchImages) }
								aria-label="Auto-fetch images"
								onclick="toggleAutoFetch(this)"
							>
								<span
									class={
										"pointer-events-none inline-block h-5 w-5 transform rounded-full bg-white shadow ring-0 transition duration-200 ease-in-out",
										templ.KV("translate-x-5", data.AutoFetchImages),
										templ.KV("translate-x-0", !data.AutoFetchImages),
									}
								></span>
							</button>
						</div>
					</div>
				</div>
				<!-- Logging Configuration -->
				<div class="sw-card bg-white dark:bg-gray-800 shadow rounded-lg">
					<div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
						<h2 class="text-lg font-semibold">Logging</h2>
						<p class="mt-1 text-sm text-gray-500 dark:text-gray-400">
							Configure log level, format, and optional file output. Changes take effect immediately.
						</p>
					</div>
					<div class="px-6 py-4">
						<form
							id="logging-config-form"
							hx-put="/api/v1/settings/logging"
							hx-target="#logging-status"
							hx-swap="innerHTML"
							class="space-y-4"
						>
							<div class="grid grid-cols-1 gap-4 sm:grid-cols-2">
								<div>
									<label for="log-level" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Level</label>
									<select
										id="log-level"
										name="level"
										class="w-full rounded-md border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 px-3 py-2 text-sm text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500"
										hx-get="/api/v1/settings/logging"
										hx-trigger="load"
										hx-swap="none"
										hx-on::after-request="if(event.detail.successful){try{var d=JSON.parse(event.detail.xhr.responseText);document.getElementById('log-level').value=d.level||'info';document.getElementById('log-format').value=d.format||'json';document.getElementById('log-file-path').value=d.file_path||'';document.getElementById('log-file-max-size').value=d.file_max_size_mb||100;document.getElementById('log-file-max-files').value=d.file_max_files||3;document.getElementById('log-file-max-age').value=d.file_max_age_days||30;toggleFileSettings();}catch(e){}}"
									>
										<option value="debug">Debug</option>
										<option value="info" selected>Info</option>
										<option value="warn">Warn</option>
										<option value="error">Error</option>
									</select>
								</div>
								<div>
									<label for="log-format" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Format</label>
									<select
										id="log-format"
										name="format"
										class="w-full rounded-md border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 px-3 py-2 text-sm text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500"
									>
										<option value="json">JSON</option>
										<option value="text">Text</option>
									</select>
								</div>
							</div>
							<div>
								<label for="log-file-path" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">File output (optional)</label>
								<input
									id="log-file-path"
									name="file_path"
									type="text"
									placeholder="/data/logs/stillwater.log"
									class="w-full rounded-md border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 px-3 py-2 text-sm text-gray-900 dark:text-gray-100 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500"
									oninput="toggleFileSettings()"
								/>
								<p class="mt-1 text-xs text-gray-500 dark:text-gray-400">Leave empty to log only to stdout. Logs are always written to stdout.</p>
							</div>
							<p id="file-rotation-hint" class="text-xs text-gray-500 dark:text-gray-400 italic">Enter a file path above to configure log rotation settings.</p>
							<div id="file-rotation-settings" class="hidden grid grid-cols-1 gap-4 sm:grid-cols-3">
								<div>
									<label for="log-file-max-size" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Max size (MB)</label>
									<input id="log-file-max-size" name="file_max_size_mb" type="number" value="100" min="1" class="w-full rounded-md border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 px-3 py-2 text-sm text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500"/>
								</div>
								<div>
									<label for="log-file-max-files" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Max files</label>
									<input id="log-file-max-files" name="file_max_files" type="number" value="3" min="1" class="w-full rounded-md border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 px-3 py-2 text-sm text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500"/>
								</div>
								<div>
									<label for="log-file-max-age" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Max age (days)</label>
									<input id="log-file-max-age" name="file_max_age_days" type="number" value="30" min="1" class="w-full rounded-md border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 px-3 py-2 text-sm text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500"/>
								</div>
							</div>
							<div class="flex items-center gap-3">
								<button type="submit" class="text-sm px-3 py-2 rounded bg-blue-600 text-white hover:bg-blue-700 transition-colors">
									Apply
								</button>
								<span id="logging-status"></span>
							</div>
						</form>
					</div>
				</div>
				@loggingScript()
			</div>
			<!-- Providers tab -->
			<div
				data-tab-panel="providers"
				class={
					"space-y-6",
					templ.KV("hidden", data.ActiveTab != "providers"),
				}
			>
				if len(data.ProviderKeys) > 0 {
					<div class="sw-card bg-white dark:bg-gray-800 shadow rounded-lg">
						<div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
							<h2 class="text-lg font-semibold">Provider API Keys</h2>
							<p class="mt-1 text-sm text-gray-500 dark:text-gray-400">
								Configure API keys for metadata providers. Providers without a configured key will be skipped during metadata lookups.
							</p>
						</div>
						<div class="px-6 py-4 space-y-4">
							for _, pk := range data.ProviderKeys {
								<div id={ "provider-card-" + string(pk.Name) }>
									@ProviderKeyCard(pk)
								</div>
							}
						</div>
					</div>
				}
				if len(data.WebSearchProviders) > 0 {
					<div class="sw-card bg-white dark:bg-gray-800 shadow rounded-lg">
						<div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
							<h2 class="text-lg font-semibold">Web Image Search</h2>
							<p class="mt-1 text-sm text-gray-500 dark:text-gray-400">
								Enable web search providers to find additional artist images beyond authoritative sources. No API key required.
							</p>
						</div>
						<div class="px-6 py-4 space-y-4">
							for _, ws := range data.WebSearchProviders {
								@WebSearchToggle(ws)
							}
						</div>
					</div>
				}
				if len(data.Priorities) > 0 {
					<div class="sw-card bg-white dark:bg-gray-800 shadow rounded-lg">
						<div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
							<h2 class="text-lg font-semibold">Provider Priorities</h2>
							<p class="mt-1 text-sm text-gray-500 dark:text-gray-400">
								Set the preferred provider order for each metadata field. Drag to reorder. Click the checkmark/X to enable or disable. Only configured providers are shown.
							</p>
						</div>
						<div class="px-6 py-4">
							<div class="space-y-3">
								for _, pri := range data.Priorities {
									@PriorityChipRow(pri, data.ProviderKeys)
								}
							</div>
						</div>
					</div>
				}
			</div>
			<!-- Connections tab -->
			<div
				data-tab-panel="connections"
				class={
					"space-y-6",
					templ.KV("hidden", data.ActiveTab != "connections"),
				}
			>
				<div class="sw-card bg-white dark:bg-gray-800 shadow rounded-lg">
					<div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
						<h2 class="text-lg font-semibold">Server Connections</h2>
						<p class="mt-1 text-sm text-gray-500 dark:text-gray-400">
							Connect to Emby, Jellyfin, or Lidarr servers for library sync and metadata push.
						</p>
					</div>
					<div class="px-6 py-4">
						<div
							id="clobber-warnings"
							hx-get="/api/v1/connections/clobber-check"
							hx-trigger="load"
							hx-swap="innerHTML"
							class="mb-4"
						></div>
						<div class="grid grid-cols-1 gap-4 lg:grid-cols-3">
							@serviceConnectionCard("emby", "Emby", "http://192.168.1.100:8096", connectionsForType(data.Connections, "emby"))
							@serviceConnectionCard("jellyfin", "Jellyfin", "http://192.168.1.100:8096", connectionsForType(data.Connections, "jellyfin"))
							@serviceConnectionCard("lidarr", "Lidarr", "http://192.168.1.100:8686", connectionsForType(data.Connections, "lidarr"))
						</div>
					</div>
				</div>
			</div>
			<!-- Libraries tab -->
			<div
				data-tab-panel="libraries"
				class={
					"space-y-6",
					templ.KV("hidden", data.ActiveTab != "libraries"),
				}
			>
				<div class="sw-card bg-white dark:bg-gray-800 shadow rounded-lg">
					<div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
						<h2 class="text-lg font-semibold">Music Libraries</h2>
						<p class="mt-1 text-sm text-gray-500 dark:text-gray-400">
							Manage your music library paths. Each library maps to a directory containing artist folders.
						</p>
					</div>
					<div class="px-6 py-4">
						<div id="settings-library-list" class="space-y-3 mb-4">
							for _, lib := range data.Libraries {
								@settingsLibraryRow(lib)
							}
							if len(data.Libraries) == 0 {
								<p id="settings-no-libraries" class="text-sm text-gray-400 dark:text-gray-500 italic">No libraries configured.</p>
							}
						</div>
						<div id="settings-library-form-wrapper">
							<button
								type="button"
								id="settings-add-library-btn"
								class="text-sm px-3 py-2 rounded bg-blue-600 text-white hover:bg-blue-700 transition-colors"
								onclick="document.getElementById('settings-library-form').classList.remove('hidden'); this.classList.add('hidden');"
							>
								Add Library
							</button>
							<form
								id="settings-library-form"
								class="hidden mt-3 space-y-3"
								hx-post="/api/v1/libraries"
								hx-swap="none"
								hx-on::after-request="if(event.detail.successful) { onSettingsLibrarySaved(); }"
							>
								<div class="grid grid-cols-1 gap-3 sm:grid-cols-3">
									<input
										name="name"
										placeholder="Library name"
										required
										class="rounded-md border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 px-3 py-2 text-sm text-gray-900 dark:text-gray-100 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500"
									/>
									<input
										name="path"
										placeholder="Path (e.g. /music)"
										required
										class="rounded-md border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 px-3 py-2 text-sm text-gray-900 dark:text-gray-100 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500"
									/>
									<select
										name="type"
										class="rounded-md border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 px-3 py-2 text-sm text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500"
									>
										<option value="regular">Regular</option>
										<option value="classical">Classical</option>
									</select>
								</div>
								<div class="flex gap-2">
									<button type="submit" class="text-sm px-3 py-2 rounded bg-green-600 text-white hover:bg-green-700 transition-colors">Save</button>
									<button type="button" class="text-sm px-3 py-2 rounded border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors" onclick="document.getElementById('settings-library-form').classList.add('hidden'); document.getElementById('settings-add-library-btn').classList.remove('hidden');">Cancel</button>
								</div>
							</form>
						</div>
					</div>
				</div>
			</div>

			<!-- Automation tab -->
			<div
				data-tab-panel="automation"
				class={
					"space-y-6",
					templ.KV("hidden", data.ActiveTab != "automation"),
				}
			>
				<div class="sw-card bg-white dark:bg-gray-800 shadow rounded-lg">
					<div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
						<h2 class="text-lg font-semibold">Webhooks</h2>
						<p class="mt-1 text-sm text-gray-500 dark:text-gray-400">
							Send notifications to external services when events occur.
						</p>
					</div>
					<div id="webhooks-list" class="px-6 py-4 space-y-3">
						if len(data.Webhooks) == 0 {
							<p class="text-sm text-gray-500 dark:text-gray-400 italic">No webhooks configured.</p>
						}
						for _, wh := range data.Webhooks {
							@webhookCard(wh)
						}
					</div>
					<div class="px-6 py-4 border-t border-gray-200 dark:border-gray-700">
						<button
							type="button"
							class="text-sm px-3 py-2 rounded bg-blue-600 text-white hover:bg-blue-700 transition-colors"
							onclick="document.getElementById('add-webhook-form').classList.toggle('hidden')"
						>
							Add Webhook
						</button>
						<div id="add-webhook-form" class="hidden mt-4">
							<form
								hx-post="/api/v1/webhooks"
								hx-target="#webhooks-list"
								hx-swap="innerHTML"
								hx-on::after-request="if(event.detail.successful) { this.reset(); this.closest('#add-webhook-form').classList.add('hidden'); window.location.reload(); }"
								class="space-y-3"
							>
								<div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
									<input name="name" placeholder="Webhook name" required class="rounded border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"/>
									<select name="type" required class="rounded border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
										<option value="">Select type...</option>
										<option value="generic">Generic (JSON)</option>
										<option value="discord">Discord</option>
										<option value="slack">Slack</option>
										<option value="gotify">Gotify</option>
									</select>
									<input name="url" type="url" placeholder="Webhook URL" required class="col-span-full rounded border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"/>
								</div>
								<div class="flex gap-2">
									<button type="submit" class="text-sm px-3 py-2 rounded bg-green-600 text-white hover:bg-green-700 transition-colors">Save</button>
									<button type="button" class="text-sm px-3 py-2 rounded border border-gray-300 dark:border-gray-600 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors" onclick="this.closest('#add-webhook-form').classList.add('hidden')">Cancel</button>
								</div>
							</form>
						</div>
					</div>
				</div>
				<!-- Notification Badge Settings -->
				<div class="sw-card bg-white dark:bg-gray-800 shadow rounded-lg">
					<div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
						<h2 class="text-lg font-semibold">Notification Badges</h2>
						<p class="mt-1 text-sm text-gray-500 dark:text-gray-400">
							Show a counter badge on the Notifications link indicating active violations.
						</p>
					</div>
					<div class="px-6 py-4 space-y-4">
						<div class="flex items-center gap-3">
							<label class="relative inline-flex items-center cursor-pointer">
								<input
									type="checkbox"
									class="sr-only peer"
									checked?={ data.BadgeEnabled }
									hx-put="/api/v1/settings"
									hx-vals='js:{"notif_badge_enabled": event.target.checked ? "true" : "false"}'
									hx-swap="none"
								/>
								<div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-blue-500 dark:peer-focus:ring-blue-600 rounded-full peer dark:bg-gray-600 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:after:border-gray-500 peer-checked:bg-blue-600"></div>
							</label>
							<span class="text-sm font-medium text-gray-700 dark:text-gray-300">Enable badge</span>
						</div>
						<div class="space-y-2">
							<p class="text-sm font-medium text-gray-700 dark:text-gray-300">Count violations by severity</p>
							<div class="flex flex-col gap-2">
								<label class="inline-flex items-center gap-2">
									<input
										type="checkbox"
										class="rounded border-gray-300 dark:border-gray-600 text-red-600 focus:ring-red-500"
										checked?={ data.BadgeSeverityError }
										hx-put="/api/v1/settings"
										hx-vals='js:{"notif_badge_severity_error": event.target.checked ? "true" : "false"}'
										hx-swap="none"
									/>
									<span class="text-sm text-gray-600 dark:text-gray-400">Errors</span>
								</label>
								<label class="inline-flex items-center gap-2">
									<input
										type="checkbox"
										class="rounded border-gray-300 dark:border-gray-600 text-amber-600 focus:ring-amber-500"
										checked?={ data.BadgeSeverityWarning }
										hx-put="/api/v1/settings"
										hx-vals='js:{"notif_badge_severity_warning": event.target.checked ? "true" : "false"}'
										hx-swap="none"
									/>
									<span class="text-sm text-gray-600 dark:text-gray-400">Warnings</span>
								</label>
								<label class="inline-flex items-center gap-2">
									<input
										type="checkbox"
										class="rounded border-gray-300 dark:border-gray-600 text-blue-600 focus:ring-blue-500"
										checked?={ data.BadgeSeverityInfo }
										hx-put="/api/v1/settings"
										hx-vals='js:{"notif_badge_severity_info": event.target.checked ? "true" : "false"}'
										hx-swap="none"
									/>
									<span class="text-sm text-gray-600 dark:text-gray-400">Info</span>
								</label>
							</div>
						</div>
					</div>
				</div>
			</div>
			<!-- Rules tab -->
			<div
				data-tab-panel="rules"
				class={
					"space-y-6",
					templ.KV("hidden", data.ActiveTab != "rules"),
				}
			>
				for _, cat := range []string{"nfo", "image", "metadata"} {
					{{ catRules := rulesForCategory(data.Rules, cat) }}
					if len(catRules) > 0 {
						<div class="sw-card bg-white dark:bg-gray-800 shadow rounded-lg">
							<div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
								<h2 class="text-lg font-semibold">{ categoryLabel(cat) } Rules</h2>
							</div>
							<div class="px-6 divide-y divide-gray-100 dark:divide-gray-700">
								for _, rl := range catRules {
									@ruleRow(rl)
								}
							</div>
						</div>
					}
				}
				if len(data.Rules) == 0 {
					<div class="sw-card bg-white dark:bg-gray-800 shadow rounded-lg px-6 py-8 text-center">
						<p class="text-sm text-gray-500 dark:text-gray-400">No rules found.</p>
					</div>
				}
			</div>
			<!-- Maintenance tab -->
			<div
				data-tab-panel="maintenance"
				class={
					"space-y-6",
					templ.KV("hidden", data.ActiveTab != "maintenance"),
				}
			>
				<div class="sw-card bg-white dark:bg-gray-800 shadow rounded-lg">
					<div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
						<h2 class="text-lg font-semibold">Confirmation Dialogs</h2>
						<p class="mt-1 text-sm text-gray-500 dark:text-gray-400">
							Manage "Don't ask again" preferences for confirmation dialogs throughout the app.
						</p>
					</div>
					<div class="px-6 py-4">
						<p class="text-sm text-gray-600 dark:text-gray-400 mb-3">
							If you previously checked "Don't ask again" on a confirmation dialog, you can reset
							all preferences here to restore those prompts.
						</p>
						<button
							type="button"
							id="reset-confirm-prefs"
							class="text-sm px-3 py-2 rounded border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors"
							onclick="resetConfirmPrefs()"
						>
							Reset all confirmation preferences
						</button>
						<span id="confirm-reset-status" class="ml-2 text-sm text-green-600 dark:text-green-400 hidden">Preferences reset.</span>
					</div>
				</div>
				<!-- Database Maintenance -->
				<div class="sw-card bg-white dark:bg-gray-800 shadow rounded-lg">
					<div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
						<h2 class="text-lg font-semibold">Database Maintenance</h2>
						<p class="mt-1 text-sm text-gray-500 dark:text-gray-400">
							Optimize database performance and reclaim disk space.
						</p>
					</div>
					<div class="px-6 py-4 space-y-4">
						<div id="maintenance-status" hx-get="/api/v1/settings/maintenance/status" hx-trigger="load" hx-swap="innerHTML">
							<p class="text-sm text-gray-500 dark:text-gray-400 italic">Loading status...</p>
						</div>
						<div class="flex items-center gap-3 pt-2 border-t border-gray-200 dark:border-gray-700">
							<button
								type="button"
								class="text-sm px-3 py-2 rounded bg-blue-600 text-white hover:bg-blue-700 transition-colors"
								hx-post="/api/v1/settings/maintenance/optimize"
								hx-target="#maintenance-status"
								hx-swap="innerHTML"
								hx-indicator="#optimize-spinner"
							>
								Optimize Now
							</button>
							<span id="optimize-spinner" class="htmx-indicator text-sm text-gray-500 dark:text-gray-400">
								Optimizing...
							</span>
							<button
								type="button"
								class="text-sm px-3 py-2 rounded bg-amber-600 text-white hover:bg-amber-700 transition-colors"
								hx-post="/api/v1/settings/maintenance/vacuum"
								hx-target="#maintenance-status"
								hx-swap="innerHTML"
								hx-indicator="#vacuum-spinner"
								hx-confirm="VACUUM rebuilds the entire database file. This may take a while for large databases and temporarily doubles disk usage. Continue?"
							>
								Vacuum
							</button>
							<span id="vacuum-spinner" class="htmx-indicator text-sm text-gray-500 dark:text-gray-400">
								Running vacuum...
							</span>
						</div>
						<div class="pt-2 border-t border-gray-200 dark:border-gray-700">
							<div class="flex items-center gap-4">
								<label class="text-sm font-medium text-gray-700 dark:text-gray-300">Auto-optimize schedule</label>
								<select
									id="maint-interval"
									onchange="updateMaintSchedule(this)"
									class="rounded-md border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 px-3 py-1.5 text-sm text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500"
								>
									<option value="6">Every 6 hours</option>
									<option value="12">Every 12 hours</option>
									<option value="24" selected>Daily (24h)</option>
									<option value="168">Weekly</option>
								</select>
								<span id="maint-schedule-status"></span>
							</div>
							<p class="mt-1 text-xs text-gray-500 dark:text-gray-400">
								Runs PRAGMA optimize and WAL checkpoint on the selected interval. Requires restart to apply schedule changes.
							</p>
						</div>
					</div>
				</div>
				<div class="sw-card bg-white dark:bg-gray-800 shadow rounded-lg">
					<div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
						<h2 class="text-lg font-semibold">Database Backup</h2>
						<p class="mt-1 text-sm text-gray-500 dark:text-gray-400">
							Create and download database backups. Automatic backups run daily with 7-day retention.
						</p>
					</div>
					<div class="px-6 py-4 space-y-4">
						<div class="flex items-center gap-3">
							<button
								type="button"
								class="text-sm px-3 py-2 rounded bg-blue-600 text-white hover:bg-blue-700 transition-colors"
								hx-post="/api/v1/settings/backup"
								hx-target="#backup-list"
								hx-swap="innerHTML"
								hx-indicator="#backup-spinner"
							>
								Create Backup
							</button>
							<span id="backup-spinner" class="htmx-indicator text-sm text-gray-500 dark:text-gray-400">
								Creating backup...
							</span>
						</div>
						<div id="backup-list" hx-get="/api/v1/settings/backup/history" hx-trigger="load" hx-swap="innerHTML">
							<p class="text-sm text-gray-500 dark:text-gray-400 italic">Loading backup history...</p>
						</div>
					</div>
				</div>
				<!-- Settings Export / Import -->
				<div class="sw-card bg-white dark:bg-gray-800 shadow rounded-lg">
					<div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
						<h2 class="text-lg font-semibold">Settings Export / Import</h2>
						<p class="mt-1 text-sm text-gray-500 dark:text-gray-400">
							Export all settings (provider keys, connections, profiles, webhooks) as an encrypted file.
							A passphrase you choose protects the file, so it can be imported on any Stillwater instance.
						</p>
					</div>
					<div class="px-6 py-4 space-y-4">
						<form
							onsubmit="event.preventDefault(); exportSettings(this);"
							class="space-y-3"
						>
							<div>
								<label for="export-passphrase" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Export passphrase</label>
								<input
									id="export-passphrase"
									name="export_passphrase"
									type="password"
									required
									minlength="8"
									placeholder="Choose a passphrase (min 8 characters)"
									class="w-full rounded-md border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 px-3 py-2 text-sm text-gray-900 dark:text-gray-100 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500"
								/>
							</div>
							<div class="flex items-center gap-3">
								<button
									type="submit"
									id="export-btn"
									class="text-sm px-3 py-2 rounded bg-blue-600 text-white hover:bg-blue-700 transition-colors"
								>
									Export Settings
								</button>
								<span id="export-spinner" class="hidden text-sm text-gray-500 dark:text-gray-400">
									Exporting...
								</span>
							</div>
						</form>
						<div class="pt-2 border-t border-gray-200 dark:border-gray-700">
							<form
								hx-post="/api/v1/settings/import"
								hx-target="#import-result"
								hx-swap="innerHTML"
								hx-encoding="multipart/form-data"
								hx-indicator="#import-spinner"
								class="space-y-3"
							>
								<div>
									<label for="import-file" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Import settings file</label>
									<input
										id="import-file"
										name="file"
										type="file"
										accept=".json"
										required
										class="block w-full text-sm text-gray-900 dark:text-gray-100 file:mr-4 file:py-2 file:px-3 file:rounded file:border-0 file:text-sm file:bg-gray-100 dark:file:bg-gray-700 file:text-gray-700 dark:file:text-gray-300 hover:file:bg-gray-200 dark:hover:file:bg-gray-600"
									/>
								</div>
								<div>
									<label for="import-passphrase" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Import passphrase</label>
									<input
										id="import-passphrase"
										name="passphrase"
										type="password"
										required
										placeholder="Enter the passphrase used during export"
										class="w-full rounded-md border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 px-3 py-2 text-sm text-gray-900 dark:text-gray-100 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500"
									/>
								</div>
								<div class="flex items-center gap-3">
									<button
										type="submit"
										class="text-sm px-3 py-2 rounded bg-green-600 text-white hover:bg-green-700 transition-colors"
									>
										Import
									</button>
									<span id="import-spinner" class="htmx-indicator text-sm text-gray-500 dark:text-gray-400">
										Importing...
									</span>
								</div>
							</form>
							<div id="import-result" class="mt-2"></div>
						</div>
						<p class="text-xs text-gray-500 dark:text-gray-400">
							The export file is encrypted with your passphrase using PBKDF2 + AES-256-GCM.
							You will need the same passphrase to import the file on any instance.
						</p>
					</div>
				</div>
			</div>
		</div>
		@sortableInitScript()
	}
}

// resetConfirmPrefsScript renders inline JS for the "Reset confirmation preferences" button.
templ resetConfirmPrefsScript() {
	<script>
		function resetConfirmPrefs() {
			var keys = [];
			for (var i = 0; i < localStorage.length; i++) {
				var key = localStorage.key(i);
				if (key && key.indexOf('ui.confirm.') === 0) {
					keys.push(key);
				}
			}
			for (var j = 0; j < keys.length; j++) {
				localStorage.removeItem(keys[j]);
			}
			var status = document.getElementById('confirm-reset-status');
			if (status) {
				status.classList.remove('hidden');
				setTimeout(function() { status.classList.add('hidden'); }, 3000);
			}
		}
	</script>
}

templ settingsTabBar(activeTab string) {
	<div class="sw-card rounded-lg p-1.5">
		<nav class="flex overflow-x-auto gap-0.5" aria-label="Settings tabs">
			for _, tab := range settingsTabs() {
				<a
					href={ templ.SafeURL("/settings?tab=" + tab.ID) }
					class={
						"whitespace-nowrap rounded-md px-4 py-2 text-sm font-medium transition-all cursor-pointer",
						templ.KV("bg-white dark:bg-gray-700 text-blue-600 dark:text-blue-300 shadow-sm", tab.ID == activeTab),
						templ.KV("text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-200 hover:bg-white/60 dark:hover:bg-gray-700/60", tab.ID != activeTab),
					}
					data-tab={ tab.ID }
					onclick="switchSettingsTab(event, this)"
				>
					{ tab.Label }
				</a>
			}
		</nav>
	</div>
}

templ loggingScript() {
	<script>
		function toggleFileSettings() {
			var path = document.getElementById('log-file-path');
			var settings = document.getElementById('file-rotation-settings');
			var hint = document.getElementById('file-rotation-hint');
			if (path && settings) {
				if (path.value.trim() !== '') {
					settings.classList.remove('hidden');
					if (hint) hint.classList.add('hidden');
				} else {
					settings.classList.add('hidden');
					if (hint) hint.classList.remove('hidden');
				}
			}
		}
	</script>
}

templ maintenanceScript() {
	<script>
		function updateMaintSchedule(sel) {
			var csrfToken = document.cookie.replace(
				/(?:(?:^|.*;\s*)csrf_token\s*=\s*([^;]*).*$)|^.*$/, "$1"
			);
			var status = document.getElementById('maint-schedule-status');
			fetch('/api/v1/settings/maintenance/schedule', {
				method: 'PUT',
				headers: {
					'Content-Type': 'application/json',
					'X-CSRF-Token': csrfToken,
					'HX-Request': 'true'
				},
				body: JSON.stringify({
					enabled: true,
					interval_hours: parseInt(sel.value, 10)
				})
			}).then(function(r) { return r.text(); })
			  .then(function(html) {
				if (status) {
					status.innerHTML = html;
					setTimeout(function() { status.innerHTML = ''; }, 3000);
				}
			}).catch(function() {
				if (status) { status.innerHTML = '<span class="text-sm text-red-600">Failed to update.</span>'; }
			});
		}

		// Initialize dropdown from current DB value after maintenance status loads.
		document.addEventListener('htmx:afterSettle', function(evt) {
			if (evt.detail && evt.detail.target && evt.detail.target.id === 'maintenance-status') {
				fetch('/api/v1/settings/maintenance/status', {
					headers: { 'Accept': 'application/json' }
				}).then(function(r) { return r.json(); })
				  .then(function(data) {
					var sel = document.getElementById('maint-interval');
					if (sel && data.schedule_interval_hours) {
						sel.value = data.schedule_interval_hours.toString();
					}
				}).catch(function() {});
			}
		});
	</script>
}

templ settingsExportScript() {
	<script>
		function exportSettings(form) {
			var pp = form.querySelector('[name=export_passphrase]').value;
			if (!pp) return;

			var btn = document.getElementById('export-btn');
			var spinner = document.getElementById('export-spinner');
			if (btn) btn.disabled = true;
			if (spinner) spinner.classList.remove('hidden');

			var csrfToken = document.cookie.replace(
				/(?:(?:^|.*;\s*)csrf_token\s*=\s*([^;]*).*$)|^.*$/, "$1"
			);

			fetch('/api/v1/settings/export', {
				method: 'POST',
				headers: {
					'Content-Type': 'application/x-www-form-urlencoded',
					'X-CSRF-Token': csrfToken
				},
				body: 'passphrase=' + encodeURIComponent(pp)
			}).then(function(r) {
				if (!r.ok) throw new Error('export failed');
				var cd = r.headers.get('Content-Disposition') || '';
				var match = cd.match(/filename="(.+?)"/);
				var filename = match ? match[1] : 'stillwater-settings.json';
				return r.blob().then(function(blob) { return { blob: blob, filename: filename }; });
			}).then(function(result) {
				var url = URL.createObjectURL(result.blob);
				var a = document.createElement('a');
				a.href = url;
				a.download = result.filename;
				document.body.appendChild(a);
				a.click();
				document.body.removeChild(a);
				URL.revokeObjectURL(url);
				form.reset();
			}).catch(function(err) {
				alert('Export failed. Please try again.');
			}).finally(function() {
				if (btn) btn.disabled = false;
				if (spinner) spinner.classList.add('hidden');
			});
		}
	</script>
}

templ autoFetchToggleScript() {
	<script>
		function toggleAutoFetch(btn) {
			var isOn = btn.getAttribute('aria-checked') === 'true';
			var newVal = !isOn;
			var csrfToken = document.cookie.replace(
				/(?:(?:^|.*;\s*)csrf_token\s*=\s*([^;]*).*$)|^.*$/, "$1"
			);
			fetch('/api/v1/settings', {
				method: 'PUT',
				headers: {
					'Content-Type': 'application/json',
					'X-CSRF-Token': csrfToken
				},
				body: JSON.stringify({'auto_fetch_images': String(newVal)}),
				credentials: 'same-origin'
			}).then(function(r) {
				if (r.ok) {
					btn.setAttribute('aria-checked', String(newVal));
					var knob = btn.querySelector('span');
					if (newVal) {
						btn.classList.remove('bg-gray-200', 'dark:bg-gray-600');
						btn.classList.add('bg-blue-600');
						knob.classList.remove('translate-x-0');
						knob.classList.add('translate-x-5');
					} else {
						btn.classList.remove('bg-blue-600');
						btn.classList.add('bg-gray-200', 'dark:bg-gray-600');
						knob.classList.remove('translate-x-5');
						knob.classList.add('translate-x-0');
					}
				} else {
					if (typeof showToast === 'function') {
						showToast('Failed to update auto-fetch setting.');
					}
				}
			}).catch(function() {
				if (typeof showToast === 'function') {
					showToast('Network error while updating setting.');
				}
			});
		}
	</script>
}

templ profileNamingEditorScript() {
	<script>
		function addNamingChip(btn, imageType) {
			var name = prompt('Enter filename (e.g. folder.jpg):');
			if (!name) return;
			name = name.trim();
			if (!name) return;

			// Client-side validation
			if (name.indexOf('/') !== -1 || name.indexOf('\\') !== -1) {
				alert('Filename must not contain path separators.');
				return;
			}
			var dotIdx = name.lastIndexOf('.');
			if (dotIdx === -1) {
				alert('Filename must have an extension (.jpg, .jpeg or .png).');
				return;
			}
			var ext = name.substring(dotIdx).toLowerCase();
			if (ext !== '.jpg' && ext !== '.jpeg' && ext !== '.png') {
				alert('Extension must be .jpg, .jpeg or .png.');
				return;
			}
			if (imageType === 'logo' && ext !== '.png') {
				alert('Logo filenames must use .png extension.');
				return;
			}

			// Check for duplicates
			var container = btn.closest('[data-naming-type]');
			var chips = container.querySelectorAll('[data-naming-chip]');
			for (var i = 0; i < chips.length; i++) {
				if (chips[i].dataset.namingChip.toLowerCase() === name.toLowerCase()) {
					alert('Duplicate filename.');
					return;
				}
			}

			var chip = document.createElement('span');
			chip.className = 'inline-flex items-center gap-1 rounded-full bg-gray-100 dark:bg-gray-700 px-2.5 py-0.5 text-xs font-medium text-gray-700 dark:text-gray-300';
			chip.dataset.namingChip = name;
			chip.textContent = name;
			var removeBtn = document.createElement('button');
			removeBtn.type = 'button';
			removeBtn.className = 'ml-0.5 text-gray-400 hover:text-red-500 focus:outline-none';
			removeBtn.setAttribute('aria-label', 'Remove ' + name);
			removeBtn.innerHTML = '&times;';
			removeBtn.onclick = function() { chip.remove(); };
			chip.appendChild(removeBtn);
			container.insertBefore(chip, btn);
		}

		function saveProfileNaming(btn) {
			var profileId = btn.dataset.profileId;
			var payload = {};
			var types = ['thumb', 'fanart', 'logo', 'banner'];
			for (var i = 0; i < types.length; i++) {
				var container = document.querySelector('[data-naming-type="' + types[i] + '"]');
				var names = [];
				if (container) {
					var chips = container.querySelectorAll('[data-naming-chip]');
					for (var j = 0; j < chips.length; j++) {
						names.push(chips[j].dataset.namingChip);
					}
				}
				payload[types[i]] = names;
			}

			var csrfToken = document.cookie.replace(
				/(?:(?:^|.*;\s*)csrf_token\s*=\s*([^;]*).*$)|^.*$/, "$1"
			);
			var status = document.getElementById('naming-save-status');
			status.textContent = 'Saving...';

			fetch('/api/v1/platforms/' + profileId, {
				method: 'PUT',
				headers: {
					'Content-Type': 'application/json',
					'X-CSRF-Token': csrfToken
				},
				body: JSON.stringify({ image_naming: payload }),
				credentials: 'same-origin'
			}).then(function(r) {
				if (r.ok) {
					status.textContent = 'Saved.';
					setTimeout(function() { status.textContent = ''; }, 2000);
				} else {
					r.json().then(function(data) {
						var msg = data.error || 'Save failed.';
						if (data.details) msg += ' ' + data.details.join('; ');
						status.textContent = msg;
					}).catch(function() {
						status.textContent = 'Save failed.';
					});
				}
			}).catch(function() {
				status.textContent = 'Network error.';
			});
		}
	</script>
}

templ settingsTabScript() {
	<script>
		function switchSettingsTab(event, el) {
			event.preventDefault();
			var tabId = el.dataset.tab;
			document.querySelectorAll('[data-tab-panel]').forEach(function(p) {
				p.classList.add('hidden');
			});
			var panel = null;
			document.querySelectorAll('[data-tab-panel]').forEach(function(p) {
				if (p.dataset.tabPanel === tabId) {
					panel = p;
				}
			});
			if (panel) panel.classList.remove('hidden');
			document.querySelectorAll('[data-tab]').forEach(function(t) {
				t.classList.remove('bg-white', 'dark:bg-gray-700', 'text-blue-600', 'dark:text-blue-300', 'shadow-sm');
				t.classList.add('text-gray-600', 'dark:text-gray-400');
			});
			el.classList.remove('text-gray-600', 'dark:text-gray-400');
			el.classList.add('bg-white', 'dark:bg-gray-700', 'text-blue-600', 'dark:text-blue-300', 'shadow-sm');
			history.replaceState(null, '', '/settings?tab=' + encodeURIComponent(tabId));
		}
	</script>
}

templ settingsLibraryRow(lib library.Library) {
	<div class="flex items-center justify-between rounded-lg border border-gray-200 dark:border-gray-700 px-4 py-3" id={ "settings-lib-" + lib.ID }>
		<div>
			<div class="font-medium text-sm text-gray-900 dark:text-gray-100">{ lib.Name }</div>
			if lib.Path != "" {
				<div class="text-xs text-gray-500 dark:text-gray-400">{ lib.Path }</div>
			}
			<div class="flex items-center gap-1.5 mt-1">
				<span class="inline-flex items-center rounded-full bg-gray-100 dark:bg-gray-700 px-2 py-0.5 text-xs text-gray-600 dark:text-gray-300">{ lib.Type }</span>
				if lib.IsDegraded() {
					<span class="inline-flex items-center rounded-full bg-amber-100 dark:bg-amber-900/30 px-2 py-0.5 text-xs text-amber-700 dark:text-amber-400">No path (API only)</span>
				}
				if lib.Source != "" && lib.Source != "manual" {
					<span class="inline-flex items-center gap-1 rounded-full bg-gray-100 dark:bg-gray-700 px-2 py-0.5 text-xs text-gray-600 dark:text-gray-300">
						<img src={ logoSrc(lib.Source) } class="h-3.5 w-3.5" alt=""/>
						{ sourceDisplayName(lib.Source) }
					</span>
				}
			</div>
		</div>
		<div class="flex items-center gap-2">
			if lib.IsDegraded() && lib.ConnectionID != "" {
				<button
					type="button"
					id={ "populate-btn-" + lib.ID }
					class="text-xs px-2 py-1 rounded bg-blue-600 text-white hover:bg-blue-700 transition-colors inline-flex items-center gap-1"
					onclick={ settingsAsyncLibOp(lib.ConnectionID, lib.ID, "populate") }
				>
					<svg id={ "populate-spinner-" + lib.ID } class="hidden animate-spin h-3 w-3" viewBox="0 0 24 24" fill="none"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path></svg>
					<span id={ "populate-label-" + lib.ID }>Populate Artists</span>
				</button>
			}
			if lib.ConnectionID != "" {
				<button
					type="button"
					id={ "scan-btn-" + lib.ID }
					class="text-xs px-2 py-1 rounded bg-gray-600 text-white hover:bg-gray-700 transition-colors inline-flex items-center gap-1"
					onclick={ settingsAsyncLibOp(lib.ConnectionID, lib.ID, "scan") }
				>
					<svg id={ "scan-spinner-" + lib.ID } class="hidden animate-spin h-3 w-3" viewBox="0 0 24 24" fill="none"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path></svg>
					<span id={ "scan-label-" + lib.ID }>Scan Library</span>
				</button>
			}
			<button
				type="button"
				class="text-xs text-red-600 dark:text-red-400 hover:text-red-800 dark:hover:text-red-300"
				onclick={ settingsDeleteLibrary(lib.ID) }
			>
				Remove
			</button>
		</div>
	</div>
}

script settingsDeleteLibrary(id string) {
	settingsDeleteLibrary_click(id);
}

script settingsAsyncLibOp(connID string, libID string, operation string) {
	runLibraryOp(connID, libID, operation);
}

templ settingsLibraryScript() {
	<script>
		function onSettingsLibrarySaved() {
			var form = document.getElementById("settings-library-form");
			if (form) { form.reset(); form.classList.add("hidden"); }
			var btn = document.getElementById("settings-add-library-btn");
			if (btn) btn.classList.remove("hidden");
			refreshSettingsLibraryList();
		}

		function refreshSettingsLibraryList() {
			var csrfToken = document.cookie.replace(/(?:(?:^|.*;\s*)csrf_token\s*=\s*([^;]*).*$)|^.*$/, "$1");
			var sourceLogos = {emby: "/static/img/logos/emby-128.png", jellyfin: "/static/img/logos/jellyfin.svg", lidarr: "/static/img/logos/lidarr.svg"};
			var sourceNames = {emby: "Emby", jellyfin: "Jellyfin", lidarr: "Lidarr"};
			fetch("/api/v1/libraries", {
				headers: {"X-CSRF-Token": csrfToken}
			}).then(function(res) { return res.json(); })
			.then(function(libs) {
				var list = document.getElementById("settings-library-list");
				if (!libs || libs.length === 0) {
					list.innerHTML = '<p id="settings-no-libraries" class="text-sm text-gray-400 dark:text-gray-500 italic">No libraries configured.</p>';
					return;
				}
				var html = "";
				libs.forEach(function(lib) {
					var div = document.createElement("div");
					div.textContent = lib.name;
					var safeName = div.innerHTML;
					div.textContent = lib.path;
					var safePath = div.innerHTML;
					div.textContent = lib.type;
					var safeType = div.innerHTML;
					var pathLine = lib.path ? '<div class="text-xs text-gray-500 dark:text-gray-400">' + safePath + '</div>' : '';
					var degradedBadge = !lib.path ? '<span class="inline-flex items-center rounded-full bg-amber-100 dark:bg-amber-900/30 px-2 py-0.5 text-xs text-amber-700 dark:text-amber-400">No path (API only)</span>' : '';
					var sourceBadge = '';
					if (lib.source && lib.source !== 'manual' && sourceNames[lib.source]) {
						sourceBadge = '<span class="inline-flex items-center gap-1 rounded-full bg-gray-100 dark:bg-gray-700 px-2 py-0.5 text-xs text-gray-600 dark:text-gray-300">'
							+ '<img src="' + sourceLogos[lib.source] + '" class="h-3.5 w-3.5" alt=""/>'
							+ sourceNames[lib.source]
							+ '</span>';
					}
					var spinnerSvg = '<svg class="hidden animate-spin h-3 w-3" viewBox="0 0 24 24" fill="none"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path></svg>';
					var populateBtn = '';
					if (!lib.path && lib.connection_id) {
						populateBtn = '<button type="button" id="populate-btn-' + lib.id + '" class="text-xs px-2 py-1 rounded bg-blue-600 text-white hover:bg-blue-700 transition-colors inline-flex items-center gap-1" onclick="runLibraryOp(&apos;' + lib.connection_id + '&apos;, &apos;' + lib.id + '&apos;, &apos;populate&apos;)">'
							+ spinnerSvg.replace('class="hidden', 'id="populate-spinner-' + lib.id + '" class="hidden')
							+ '<span id="populate-label-' + lib.id + '">Populate Artists</span></button>';
					}
					var scanBtn = '';
					if (lib.connection_id) {
						scanBtn = '<button type="button" id="scan-btn-' + lib.id + '" class="text-xs px-2 py-1 rounded bg-gray-600 text-white hover:bg-gray-700 transition-colors inline-flex items-center gap-1" onclick="runLibraryOp(&apos;' + lib.connection_id + '&apos;, &apos;' + lib.id + '&apos;, &apos;scan&apos;)">'
							+ spinnerSvg.replace('class="hidden', 'id="scan-spinner-' + lib.id + '" class="hidden')
							+ '<span id="scan-label-' + lib.id + '">Scan Library</span></button>';
					}
					html += '<div class="flex items-center justify-between rounded-lg border border-gray-200 dark:border-gray-700 px-4 py-3" id="settings-lib-' + lib.id + '">'
						+ '<div>'
						+ '<div class="font-medium text-sm text-gray-900 dark:text-gray-100">' + safeName + '</div>'
						+ pathLine
						+ '<div class="flex items-center gap-1.5 mt-1">'
						+ '<span class="inline-flex items-center rounded-full bg-gray-100 dark:bg-gray-700 px-2 py-0.5 text-xs text-gray-600 dark:text-gray-300">' + safeType + '</span>'
						+ degradedBadge
						+ sourceBadge
						+ '</div>'
						+ '</div>'
						+ '<div class="flex items-center gap-2">'
						+ populateBtn
						+ scanBtn
						+ '<button type="button" class="text-xs text-red-600 dark:text-red-400 hover:text-red-800 dark:hover:text-red-300" onclick="settingsDeleteLibrary_click(&apos;' + lib.id + '&apos;)">'
						+ 'Remove'
						+ '</button>'
						+ '</div>'
						+ '</div>';
				});
				list.innerHTML = html;
			});
		}

		function runLibraryOp(connID, libID, operation) {
			var csrfToken = document.cookie.replace(/(?:(?:^|.*;\s*)csrf_token\s*=\s*([^;]*).*$)|^.*$/, "$1");
			var btn = document.getElementById(operation + '-btn-' + libID);
			var spinner = document.getElementById(operation + '-spinner-' + libID);
			var label = document.getElementById(operation + '-label-' + libID);
			var endpoint = "/api/v1/connections/" + connID + "/libraries/" + libID + "/" + operation;

			fetch(endpoint, {
				method: "POST",
				headers: {"X-CSRF-Token": csrfToken}
			}).then(function(res) {
				if (res.status === 409) {
					showToast("Operation already running for this library");
					return;
				}
				if (res.status === 202) {
					if (btn) btn.disabled = true;
					if (spinner) spinner.classList.remove('hidden');
					if (label) label.textContent = operation === 'populate' ? 'Populating...' : 'Scanning...';
					pollLibraryOp(libID, operation, btn, spinner, label);
					return;
				}
				if (!res.ok) {
					res.text().then(function(body) {
						var message = "Operation failed (HTTP " + res.status + ")";
						if (body) {
							try {
								var data = JSON.parse(body);
								if (data && data.error) {
									message = data.error;
								}
							} catch (e) {
								// Body is not JSON; keep default message.
							}
						}
						showToast(message);
					}).catch(function() {
						showToast("Operation failed (HTTP " + res.status + ")");
					});
					return;
				}
				res.json().then(function(data) {
					showToast((data && data.error) || "Operation failed");
				}).catch(function() {
					showToast("Operation failed");
				});
			}).catch(function() {
				showToast("Network error");
			});
		}

		function pollLibraryOp(libID, operation, btn, spinner, label) {
			var csrfToken = document.cookie.replace(/(?:(?:^|.*;\s*)csrf_token\s*=\s*([^;]*).*$)|^.*$/, "$1");
			var attempts = 0;
			var maxAttempts = 150;
			function resetUI() {
				if (btn) btn.disabled = false;
				if (spinner) spinner.classList.add('hidden');
				if (label) label.textContent = operation === 'populate' ? 'Populate Artists' : 'Scan Library';
			}
			var poll = setInterval(function() {
				attempts++;
				if (attempts > maxAttempts) {
					clearInterval(poll);
					resetUI();
					showToast("Operation timed out");
					return;
				}
				fetch("/api/v1/libraries/" + libID + "/operation/status", {
					headers: {"X-CSRF-Token": csrfToken}
				})
				.then(function(r) {
					if (!r.ok) {
						clearInterval(poll);
						resetUI();
						showToast("Status check failed (HTTP " + r.status + ")");
						return null;
					}
					return r.json();
				})
				.then(function(data) {
					if (!data) return;
					if (data.status === 'completed') {
						clearInterval(poll);
						resetUI();
						showSuccessToast(data.message || 'Operation completed');
						if (operation === 'populate') refreshSettingsLibraryList();
					} else if (data.status === 'failed') {
						clearInterval(poll);
						resetUI();
						showToast(data.message || 'Operation failed');
					} else if (data.status === 'idle') {
						clearInterval(poll);
						resetUI();
						showToast("Operation state lost (server may have restarted)");
					}
				})
				.catch(function() {
					clearInterval(poll);
					resetUI();
					showToast("Network error while checking operation status");
				});
			}, 2000);
		}

		function settingsDeleteLibrary_click(id) {
			var csrfToken = document.cookie.replace(/(?:(?:^|.*;\s*)csrf_token\s*=\s*([^;]*).*$)|^.*$/, "$1");
			function doDelete(deleteArtists) {
				var url = "/api/v1/libraries/" + id;
				if (deleteArtists) { url += "?deleteArtists=true"; }
				fetch(url, {
					method: "DELETE",
					headers: {"X-CSRF-Token": csrfToken}
				}).then(function(res) {
					if (res.ok) {
						refreshSettingsLibraryList();
					} else {
						res.json().then(function(data) { alert(data.error || "Failed to delete library"); });
					}
				}).catch(function() {
					alert("Failed to delete library");
				});
			}

			fetch("/api/v1/libraries/" + id, {
				headers: {"X-CSRF-Token": csrfToken}
			}).then(function(res) {
				if (!res.ok) {
					showConfirmDialog("Remove this library?", null, function() { doDelete(false); });
					return;
				}
				return res.json();
			})
			.then(function(data) {
				if (!data) return;
				var count = data.artist_count || 0;
				if (count === 0) {
					showConfirmDialog("Remove this library?", null, function() { doDelete(false); });
					return;
				}
				var noun = count === 1 ? "artist" : "artists";
				var msg = '<p class="mb-3">This library has <strong>' + count + '</strong> ' + noun + '.</p>'
					+ '<label class="flex items-center gap-2 mb-1 cursor-pointer">'
					+ '<input type="radio" name="lib-delete-choice" value="delete" checked class="text-blue-600"/> Delete ' + noun
					+ '</label>'
					+ '<label class="flex items-center gap-2 cursor-pointer">'
					+ '<input type="radio" name="lib-delete-choice" value="keep" class="text-blue-600"/> Keep ' + noun + ' (unassign from library)'
					+ '</label>';
				showConfirmDialog(msg, null, function() {
					var checked = document.querySelector('input[name="lib-delete-choice"]:checked');
					doDelete(checked && checked.value === 'delete');
				}, {html: true});
			})
			.catch(function() {
				showConfirmDialog("Remove this library?", null, function() { doDelete(false); });
			});
		}
	</script>
}

templ settingsConnectionScript() {
	<script>
		function settingsDeleteConnection_click(id) {
			var csrfToken = document.cookie.replace(/(?:(?:^|.*;\s*)csrf_token\s*=\s*([^;]*).*$)|^.*$/, "$1");

			function doDelete(params) {
				var url = "/api/v1/connections/" + id;
				if (params) { url += "?" + params; }
				fetch(url, {
					method: "DELETE",
					headers: {"X-CSRF-Token": csrfToken}
				}).then(function(res) {
					if (res.ok) { window.location.reload(); }
					else { res.json().then(function(data) { alert(data.error || "Failed to delete connection"); }); }
				}).catch(function() {
					alert("Failed to delete connection");
				});
			}

			fetch("/api/v1/connections/" + id, {
				headers: {"X-CSRF-Token": csrfToken}
			}).then(function(res) {
				if (!res.ok) {
					showConfirmDialog("Delete this connection?", null, function() { doDelete(""); });
					return;
				}
				return res.json();
			}).then(function(data) {
				if (!data) return;
				var libCount = data.library_count || 0;
				var artistCount = data.artist_count || 0;

				if (libCount === 0 && artistCount === 0) {
					showConfirmDialog("Delete this connection?", null, function() { doDelete(""); });
					return;
				}

				var libNoun = libCount === 1 ? "library" : "libraries";
				var artistNoun = artistCount === 1 ? "artist" : "artists";
				var msg = '<p class="mb-3">This connection has <strong>' + libCount + '</strong> ' + libNoun;
				if (artistCount > 0) {
					msg += ' and <strong>' + artistCount + '</strong> ' + artistNoun;
				}
				msg += '.</p>';
				var allLabel = artistCount > 0
						? ' Delete connection, ' + libNoun + ', and ' + artistNoun
						: ' Delete connection and ' + libNoun;
				var libsLabel = artistCount > 0
						? ' Delete connection and ' + libNoun + ' (keep ' + artistNoun + ')'
						: ' Delete connection and ' + libNoun;
				var connLabel = artistCount > 0
						? ' Delete connection only (keep ' + libNoun + ' and ' + artistNoun + ')'
						: ' Delete connection only (keep ' + libNoun + ')';

				msg += '<label class="flex items-center gap-2 mb-1 cursor-pointer">'
					+ '<input type="radio" name="conn-delete-choice" value="all" checked class="text-blue-600"/>'
					+ allLabel
					+ '</label>';
				if (artistCount > 0) {
					msg += '<label class="flex items-center gap-2 mb-1 cursor-pointer">'
						+ '<input type="radio" name="conn-delete-choice" value="libs" class="text-blue-600"/>'
						+ libsLabel
						+ '</label>';
				}
				msg += '<label class="flex items-center gap-2 cursor-pointer">'
					+ '<input type="radio" name="conn-delete-choice" value="conn" class="text-blue-600"/>'
					+ connLabel
					+ '</label>';

				showConfirmDialog(msg, null, function() {
					var checked = document.querySelector('input[name="conn-delete-choice"]:checked');
					var val = checked ? checked.value : "conn";
					if (val === "all") {
						doDelete("deleteLibraries=true&deleteArtists=true");
					} else if (val === "libs") {
						doDelete("deleteLibraries=true");
					} else {
						doDelete("");
					}
				}, {html: true});
			}).catch(function() {
				showConfirmDialog("Delete this connection?", null, function() { doDelete(""); });
			});
		}
	</script>
}

templ connectionFeatureToggleScript() {
	<script>
		function toggleConnectionFeature(btn) {
			var connID = btn.dataset.connId;
			var feature = btn.dataset.feature;
			var isOn = btn.getAttribute('aria-checked') === 'true';
			var newVal = !isOn;

			// Optimistic UI update
			btn.setAttribute('aria-checked', String(newVal));
			var knob = btn.querySelector('span');
			if (newVal) {
				btn.classList.remove('bg-gray-200', 'dark:bg-gray-600');
				btn.classList.add('bg-blue-600');
				knob.classList.remove('translate-x-0');
				knob.classList.add('translate-x-5');
			} else {
				btn.classList.remove('bg-blue-600');
				btn.classList.add('bg-gray-200', 'dark:bg-gray-600');
				knob.classList.remove('translate-x-5');
				knob.classList.add('translate-x-0');
			}

			var csrfToken = document.cookie.replace(/(?:(?:^|.*;\s*)csrf_token\s*=\s*([^;]*).*$)|^.*$/, "$1");
			var body = {};
			body['feature_' + feature] = newVal;
			fetch('/api/v1/connections/' + connID + '/features', {
				method: 'PATCH',
				headers: {
					'Content-Type': 'application/json',
					'X-CSRF-Token': csrfToken
				},
				body: JSON.stringify(body)
			}).then(function(r) {
				if (!r.ok && typeof showToast === 'function') {
					showToast('Failed to update feature toggle.');
				}
			}).catch(function() {
				if (typeof showToast === 'function') {
					showToast('Network error updating feature toggle.');
				}
			});
		}
	</script>
}

templ sortableInitScript() {
	<script>
		(function() {
			if (typeof Sortable === 'undefined') return;
			document.querySelectorAll('[data-sortable-field]').forEach(function(container) {
				var field = container.dataset.sortableField;
				Sortable.create(container, {
					handle: '.drag-handle',
					animation: 150,
					ghostClass: 'opacity-30',
					dragClass: 'shadow-lg',
					onChoose: function(evt) {
						evt.item.classList.add('ring-2', 'ring-blue-400', 'rounded-full');
					},
					onUnchoose: function(evt) {
						evt.item.classList.remove('ring-2', 'ring-blue-400', 'rounded-full');
					},
					onEnd: function() {
						var providers = [];
						container.querySelectorAll('[data-provider]').forEach(function(chip) {
							providers.push(chip.dataset.provider);
						});
						// Include disabled providers so they are not dropped from the persisted list.
						var row = container.closest('[id^="priority-row-"]');
						if (row) {
							row.querySelectorAll('[data-disabled-provider]').forEach(function(chip) {
								providers.push(chip.dataset.disabledProvider);
							});
						}
						var csrfToken = document.cookie.replace(
							/(?:(?:^|.*;\s*)csrf_token\s*=\s*([^;]*).*$)|^.*$/, "$1"
						);
						fetch('/api/v1/providers/priorities', {
							method: 'PUT',
							headers: {
								'Content-Type': 'application/json',
								'X-CSRF-Token': csrfToken
							},
							body: JSON.stringify({
								priorities: [{field: field, providers: providers}]
							}),
							credentials: 'same-origin'
						}).then(function(r) {
							if (!r.ok) {
								if (typeof showToast === 'function') {
									showToast('Failed to save provider order');
								}
								window.location.reload();
							}
						}).catch(function() {
							if (typeof showToast === 'function') {
								showToast('Failed to save provider order');
							}
							window.location.reload();
						});
					}
				});
			});
		})();
	</script>
}

templ ProviderKeyCard(pk provider.ProviderKeyStatus) {
	<div class="flex flex-col gap-2 rounded-lg border border-gray-200 dark:border-gray-700 px-4 py-3 sm:flex-row sm:items-center sm:justify-between">
		<div class="flex items-center gap-3">
			if logoSrcSet(string(pk.Name)) != "" {
				<img
					src={ logoSrc(string(pk.Name)) }
					srcset={ logoSrcSet(string(pk.Name)) }
					alt=""
					class="h-6 w-6 shrink-0"
					aria-hidden="true"
				/>
			} else {
				<img
					src={ logoSrc(string(pk.Name)) }
					alt=""
					class="h-6 w-6 shrink-0"
					aria-hidden="true"
				/>
			}
			<div
				class={
					"h-2.5 w-2.5 shrink-0 rounded-full",
					templ.KV("bg-green-500", pk.Status == "ok" || pk.Status == "not_required"),
					templ.KV("bg-yellow-500", pk.Status == "untested"),
					templ.KV("bg-red-500", pk.Status == "invalid" || pk.Status == "error"),
					templ.KV("bg-gray-400 dark:bg-gray-500", pk.Status == "unconfigured"),
				}
			></div>
			<div>
				<div class="flex items-center gap-2">
					<span class="font-medium text-sm">{ pk.DisplayName }</span>
					if pk.AccessTier != "" {
						<span
							class={ "inline-flex items-center rounded-full px-2 py-0.5 text-xs font-medium", tierBadgeClasses(pk.AccessTier) }
							title={ tierTooltip(pk.AccessTier) }
							aria-describedby={ "tier-tooltip-" + string(pk.Name) }
						>
							{ tierBadgeLabel(pk.AccessTier) }
						</span>
						<span id={ "tier-tooltip-" + string(pk.Name) } class="sr-only">{ tierTooltip(pk.AccessTier) }</span>
					}
				</div>
				{{ rlText := rateLimitText(pk.RateLimit) }}
				<div class="flex items-center gap-2 mt-0.5">
					if !pk.RequiresKey && !pk.OptionalKey {
						<span class="text-xs text-gray-500 dark:text-gray-400">No API key required</span>
					} else if pk.OptionalKey && pk.HasKey {
						<span class="text-xs text-gray-500 dark:text-gray-400">Premium key configured</span>
					} else if pk.OptionalKey {
						<span class="text-xs text-gray-500 dark:text-gray-400">Free tier (optional premium upgrade)</span>
					} else if pk.HasKey {
						<span class="text-xs text-gray-500 dark:text-gray-400">Key configured</span>
					} else {
						<span class="text-xs text-amber-600 dark:text-amber-400">API key required</span>
					}
					if rlText != "" {
						<span class="text-xs text-gray-400 dark:text-gray-500">{ rlText }</span>
					}
				</div>
			</div>
		</div>
		<div class="flex items-center gap-2">
			if pk.RequiresKey || pk.OptionalKey {
				if pk.HelpURL != "" {
					<a
						href={ templ.SafeURL(pk.HelpURL) }
						target="_blank"
						rel="noopener noreferrer"
						class="text-sm text-blue-600 dark:text-blue-400 hover:underline"
					>
						{ getKeyLinkText(pk.AccessTier) }
					</a>
				}
				<button
					type="button"
					class="text-sm px-3 py-1.5 rounded border border-gray-300 dark:border-gray-600 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors"
					onclick={ toggleKeyInput(string(pk.Name)) }
				>
					if pk.HasKey {
						Update
					} else {
						Configure
					}
				</button>
				if pk.HasKey {
					<button
						type="button"
						class="text-sm px-3 py-1.5 rounded bg-blue-600 text-white hover:bg-blue-700 transition-colors"
						hx-post={ "/api/v1/providers/" + string(pk.Name) + "/test" }
						hx-target={ "#test-result-" + string(pk.Name) }
						hx-swap="innerHTML"
					>
						Test
					</button>
				}
			}
		</div>
	</div>
	if pk.RequiresKey || pk.OptionalKey {
		<div id={ "key-input-" + string(pk.Name) } class="hidden mt-2 sm:ml-8">
			<form
				class="flex flex-col gap-2 sm:flex-row sm:items-center"
				hx-put={ "/api/v1/providers/" + string(pk.Name) + "/key" }
				hx-target={ "#provider-card-" + string(pk.Name) }
				hx-swap="innerHTML"
				hx-on::after-request="if(event.detail.successful) this.closest('[id^=key-input-]').classList.add('hidden')"
			>
				<input
					type="text"
					name="api_key"
					if pk.OptionalKey {
						placeholder="Enter premium API key..."
					} else {
						placeholder="Enter API key..."
					}
					autocomplete="off"
					data-1p-ignore
					data-lpignore="true"
					class="flex-1 rounded border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
					required
				/>
				<div class="flex gap-2">
					<button
						type="submit"
						class="text-sm px-3 py-2 rounded bg-green-600 text-white hover:bg-green-700 transition-colors"
					>
						Save
					</button>
					<button
						type="button"
						class="text-sm px-3 py-2 rounded border border-gray-300 dark:border-gray-600 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors"
						onclick={ toggleKeyInput(string(pk.Name)) }
					>
						Cancel
					</button>
				</div>
			</form>
		</div>
		<div id={ "test-result-" + string(pk.Name) } class="ml-8 text-xs mt-1"></div>
		<div id={ "provider-save-result-" + string(pk.Name) } class="mt-1"></div>
	}
}

script toggleKeyInput(providerName string) {
	const el = document.getElementById("key-input-" + providerName);
	if (el) {
		el.classList.toggle("hidden");
	}
}

templ ProviderTestResult(status string, message string) {
	if status == "ok" {
		<span class="text-green-600 dark:text-green-400">Connection successful</span>
	} else {
		<span class="text-red-600 dark:text-red-400">{ message }</span>
	}
}

// ProviderTestSaveFailure renders inline error with "Save anyway" when a
// provider key test fails during save. In OOBE mode the fragment preserves
// the card wrapper ID so subsequent swaps can still find the target.
templ ProviderTestSaveFailure(name provider.ProviderName, apiKey string, errMsg string, isOOBE bool) {
	if isOOBE {
		<div id={ "ob-provider-card-" + string(name) } class="rounded-lg border border-gray-200 dark:border-gray-700 px-4 py-3">
			@providerTestSaveFailureInner(name, apiKey, errMsg, isOOBE)
		</div>
	} else {
		@providerTestSaveFailureInner(name, apiKey, errMsg, isOOBE)
	}
}

templ providerTestSaveFailureInner(name provider.ProviderName, apiKey string, errMsg string, isOOBE bool) {
	<div class="mt-2 sm:ml-8">
		<div class="rounded-md border border-red-300 dark:border-red-700 bg-red-50 dark:bg-red-900/20 p-3">
			<p class="text-sm text-red-700 dark:text-red-300 mb-2">
				Test failed: { errMsg }
			</p>
			<form
				class="flex gap-2"
				hx-put={ "/api/v1/providers/" + string(name) + "/key" }
				if isOOBE {
					hx-target={ "#ob-provider-card-" + string(name) }
					hx-swap="outerHTML"
				} else {
					hx-target={ "#provider-card-" + string(name) }
					hx-swap="innerHTML"
				}
			>
				<input type="hidden" name="api_key" value={ apiKey }/>
				<input type="hidden" name="skip_test" value="true"/>
				<button
					type="submit"
					class="text-sm px-3 py-1.5 rounded bg-amber-600 text-white hover:bg-amber-700 transition-colors"
				>
					Save anyway
				</button>
				<button
					type="button"
					class="text-sm px-3 py-1.5 rounded border border-gray-300 dark:border-gray-600 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors"
					onclick="window.location.reload()"
				>
					Cancel
				</button>
			</form>
		</div>
	</div>
}

templ PriorityChipRow(pri provider.FieldPriority, keys []provider.ProviderKeyStatus) {
	@priorityChipRowInner(pri, availableProviders(pri, keys))
}

templ priorityChipRowInner(pri provider.FieldPriority, available []provider.ProviderName) {
	<div id={ "priority-row-" + pri.Field } class="rounded-lg border border-gray-200 dark:border-gray-700 px-4 py-3">
		<div class="flex items-center gap-3 mb-2">
			<span class="text-sm font-medium capitalize w-24 shrink-0">{ pri.Field }</span>
			<span class="text-xs text-gray-400 dark:text-gray-500">Drag to reorder. Click to enable/disable.</span>
		</div>
		<div class="flex flex-wrap gap-2" data-sortable-field={ pri.Field }>
			for _, prov := range available {
				if !providerIsDisabled(prov, pri.Disabled) {
					<div
						class={
							"inline-flex items-center gap-1.5 px-2.5 py-1.5 rounded-full text-xs font-medium cursor-grab select-none transition-colors border",
							templ.KV("bg-green-50 dark:bg-green-900/20 text-green-700 dark:text-green-300 border-green-300 dark:border-green-700", !isWebSearchProvider(prov)),
							templ.KV("bg-purple-50 dark:bg-purple-900/20 text-purple-700 dark:text-purple-300 border-dashed border-purple-300 dark:border-purple-700", isWebSearchProvider(prov)),
						}
						data-provider={ string(prov) }
					>
						<span class="drag-handle cursor-grab">
							if isWebSearchProvider(prov) {
								@components.IconBars2("h-3 w-3 text-purple-500 dark:text-purple-400")
							} else {
								@components.IconBars2("h-3 w-3 text-green-500 dark:text-green-400")
							}
						</span>
						<span>{ prov.DisplayName() }</span>
						<button
							type="button"
							class="ml-0.5 text-green-500 dark:text-green-400 hover:text-red-500 dark:hover:text-red-400"
							title="Disable this provider"
							hx-put={ "/api/v1/providers/priorities/" + pri.Field + "/" + string(prov) + "/toggle" }
							hx-target={ "#priority-row-" + pri.Field }
							hx-swap="outerHTML"
						>
							@components.IconCheck("h-3.5 w-3.5")
						</button>
					</div>
				}
			}
		</div>
		for _, prov := range available {
			if providerIsDisabled(prov, pri.Disabled) {
				<div
					class="inline-flex items-center gap-1.5 px-2.5 py-1.5 rounded-full text-xs font-medium select-none transition-colors border bg-red-50 dark:bg-red-900/20 text-red-600 dark:text-red-400 border-red-300 dark:border-red-700 opacity-60 mt-2"
					data-disabled-provider={ string(prov) }
				>
					<span>{ prov.DisplayName() }</span>
					<button
						type="button"
						class="ml-0.5 text-red-500 dark:text-red-400 hover:text-green-500 dark:hover:text-green-400"
						title="Enable this provider"
						hx-put={ "/api/v1/providers/priorities/" + pri.Field + "/" + string(prov) + "/toggle" }
						hx-target={ "#priority-row-" + pri.Field }
						hx-swap="outerHTML"
					>
						@components.IconXMark("h-3.5 w-3.5")
					</button>
				</div>
			}
		}
		if len(available) == 0 {
			<p class="text-xs text-gray-400 dark:text-gray-500 italic mt-1">No configured providers for this field.</p>
		}
	</div>
}

templ WebSearchToggle(ws provider.WebSearchProviderStatus) {
	<div class="flex flex-col gap-2 rounded-lg border border-gray-200 dark:border-gray-700 px-4 py-3 sm:flex-row sm:items-center sm:justify-between">
		<div class="flex items-center gap-3">
			<img src={ logoSrc(string(ws.Name)) } alt="" class="h-6 w-6 shrink-0" aria-hidden="true"/>
			<div
				class={
					"h-2.5 w-2.5 shrink-0 rounded-full",
					templ.KV("bg-green-500", ws.Enabled),
					templ.KV("bg-gray-400 dark:bg-gray-500", !ws.Enabled),
				}
			></div>
			<div>
				<div class="font-medium text-sm">{ ws.DisplayName }</div>
				<div class="text-xs text-gray-500 dark:text-gray-400">No API key required</div>
			</div>
		</div>
		<button
			type="button"
			class={
				"text-sm px-3 py-1.5 rounded border transition-colors",
				templ.KV("border-green-300 dark:border-green-700 bg-green-50 dark:bg-green-900/20 text-green-700 dark:text-green-300 hover:bg-green-100 dark:hover:bg-green-900/40", ws.Enabled),
				templ.KV("border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700", !ws.Enabled),
			}
			hx-put={ "/api/v1/providers/websearch/" + string(ws.Name) + "/toggle" }
			hx-vals={ webSearchToggleJSON(!ws.Enabled) }
			hx-swap="none"
		>
			if ws.Enabled {
				Enabled
			} else {
				Disabled
			}
		</button>
	</div>
}

templ serviceConnectionCard(connType string, displayName string, exampleURL string, conns []connection.Connection) {
	<div class="rounded-lg border border-gray-200 dark:border-gray-700 p-4">
		<div class="flex items-center gap-3 mb-3">
			if logoSrcSet(connType) != "" {
				<img
					src={ logoSrc(connType) }
					srcset={ logoSrcSet(connType) }
					alt=""
					class="h-8 w-8 shrink-0"
					aria-hidden="true"
				/>
			} else {
				<img
					src={ logoSrc(connType) }
					alt=""
					class="h-8 w-8 shrink-0"
					aria-hidden="true"
				/>
			}
			<div class="flex items-center gap-2">
				<span class="font-medium text-sm">{ displayName }</span>
				<div
					class={
						"h-2 w-2 shrink-0 rounded-full",
						templ.KV("bg-green-500", hasOKConnection(conns)),
						templ.KV("bg-gray-400 dark:bg-gray-500", !hasOKConnection(conns)),
					}
				></div>
			</div>
		</div>
		if len(conns) > 0 {
			<div class="space-y-2 mb-3">
				for _, c := range conns {
					<div class="flex flex-col gap-1.5 rounded border border-gray-100 dark:border-gray-700 px-3 py-2 sm:flex-row sm:items-center sm:justify-between">
						<div class="flex items-center gap-2 min-w-0">
							<div
								class={
									"h-2 w-2 shrink-0 rounded-full",
									templ.KV("bg-green-500", c.Status == "ok"),
									templ.KV("bg-red-500", c.Status == "error"),
									templ.KV("bg-gray-400 dark:bg-gray-500", c.Status != "ok" && c.Status != "error"),
								}
							></div>
							<div class="min-w-0">
								<div class="font-medium text-xs">{ c.Name }</div>
								<div class="text-xs text-gray-500 dark:text-gray-400 truncate">{ c.URL }</div>
							</div>
						</div>
						<div class="flex items-center gap-1.5 shrink-0">
							<button
								type="button"
								class="text-xs p-1 rounded border border-gray-300 dark:border-gray-600 text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors"
								onclick={ toggleConnectionFeatures(c.ID) }
								title="Feature toggles"
								aria-label="Feature toggles"
								aria-expanded="false"
								aria-controls={ "features-" + c.ID }
							>
								@components.IconCog6Tooth("h-3.5 w-3.5")
							</button>
							<button
								type="button"
								class="text-xs px-2 py-1 rounded bg-blue-600 text-white hover:bg-blue-700 transition-colors"
								hx-post={ "/api/v1/connections/" + c.ID + "/test" }
								hx-swap="none"
								hx-on::after-request="window.location.reload()"
							>
								Test
							</button>
							if c.Status == "ok" {
								<button
									type="button"
									class="text-xs px-2 py-1 rounded border border-blue-300 dark:border-blue-700 text-blue-600 dark:text-blue-400 hover:bg-blue-50 dark:hover:bg-blue-900/20 transition-colors"
									hx-get={ "/api/v1/connections/" + c.ID + "/libraries" }
									hx-target={ "#discover-" + c.ID }
									hx-swap="innerHTML"
								>
									Discover Libraries
								</button>
							}
							<button
								type="button"
								class="text-xs px-2 py-1 rounded border border-red-300 dark:border-red-700 text-red-600 dark:text-red-400 hover:bg-red-50 dark:hover:bg-red-900/20 transition-colors"
								onclick={ settingsDeleteConnection(c.ID) }
							>
								Delete
							</button>
						</div>
					</div>
					<div id={ "discover-" + c.ID } class="mt-2"></div>
					<div id={ "features-" + c.ID } class="hidden mt-2 rounded border border-gray-100 dark:border-gray-700 bg-gray-50 dark:bg-gray-800/50 px-3 py-2">
						<div class="text-xs font-medium text-gray-600 dark:text-gray-400 mb-2">Feature Toggles</div>
						<div class="space-y-2">
							@connectionFeatureToggle(c.ID, "library_import", "Library import", c.FeatureLibraryImport)
							@connectionFeatureToggle(c.ID, "nfo_write", "NFO write detection", c.FeatureNFOWrite)
							@connectionFeatureToggle(c.ID, "image_write", "Image download/write", c.FeatureImageWrite)
						</div>
					</div>
				}
			</div>
		} else {
			<p class="text-xs text-gray-500 dark:text-gray-400 italic mb-3">Not configured</p>
		}
		<button
			type="button"
			class="text-xs px-3 py-1.5 rounded border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors"
			onclick={ toggleConnectionForm(connType) }
		>
			if len(conns) > 0 {
				Add another
			} else {
				Configure
			}
		</button>
		<div id={ "conn-form-" + connType } class="hidden mt-3">
			<form
				class="space-y-2"
				hx-post="/api/v1/connections"
				hx-target={ "#conn-result-" + connType }
				hx-swap="innerHTML"
			>
				<input type="hidden" name="type" value={ connType }/>
				<input
					name="name"
					placeholder={ displayName + " server" }
					required
					class="w-full rounded border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
				/>
				<input
					name="url"
					type="url"
					placeholder={ "URL (e.g. " + exampleURL + ")" }
					required
					class="w-full rounded border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
				/>
				<input
					name="api_key"
					type="text"
					placeholder="API Key"
					required
					autocomplete="off"
					data-1p-ignore
					data-lpignore="true"
					class="w-full rounded border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
				/>
				<div class="flex gap-2">
					<button type="submit" class="text-xs px-3 py-1.5 rounded bg-green-600 text-white hover:bg-green-700 transition-colors">Save</button>
					<button type="button" class="text-xs px-3 py-1.5 rounded border border-gray-300 dark:border-gray-600 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors" onclick={ toggleConnectionForm(connType) }>Cancel</button>
				</div>
			</form>
			<div id={ "conn-result-" + connType } class="mt-2"></div>
		</div>
	</div>
}

// ConnectionTestSaveFailure renders inline error with "Save anyway" when a
// connection test fails during save. The isOOBE flag controls targeting.
templ ConnectionTestSaveFailure(connType string, name string, url string, apiKey string, errMsg string, isOOBE bool) {
	<div class="rounded-md border border-red-300 dark:border-red-700 bg-red-50 dark:bg-red-900/20 p-3">
		<p class="text-sm text-red-700 dark:text-red-300 mb-2">
			Test failed: { errMsg }
		</p>
		<form
			class="flex gap-2"
			hx-post="/api/v1/connections"
			if isOOBE {
				hx-target={ "#ob-conn-result-" + connType }
			} else {
				hx-target={ "#conn-result-" + connType }
			}
			hx-swap="innerHTML"
		>
			<input type="hidden" name="type" value={ connType }/>
			<input type="hidden" name="name" value={ name }/>
			<input type="hidden" name="url" value={ url }/>
			<input type="hidden" name="api_key" value={ apiKey }/>
			<input type="hidden" name="skip_test" value="true"/>
			<button
				type="submit"
				class="text-sm px-3 py-1.5 rounded bg-amber-600 text-white hover:bg-amber-700 transition-colors"
			>
				Save anyway
			</button>
			<button
				type="button"
				class="text-sm px-3 py-1.5 rounded border border-gray-300 dark:border-gray-600 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors"
				onclick="window.location.reload()"
			>
				Cancel
			</button>
		</form>
	</div>
}

script toggleConnectionForm(connType string) {
	var form = document.getElementById("conn-form-" + connType);
	if (form) {
		form.classList.toggle("hidden");
	}
}

script toggleConnectionFeatures(connID string) {
	var panel = document.getElementById("features-" + connID);
	if (panel) {
		panel.classList.toggle("hidden");
		var btn = document.querySelector('[aria-controls="features-' + connID + '"]');
		if (btn) {
			btn.setAttribute('aria-expanded', String(!panel.classList.contains('hidden')));
		}
	}
}

templ connectionFeatureToggle(connID string, feature string, label string, enabled bool) {
	<div class="flex items-center justify-between">
		<span class="text-xs text-gray-700 dark:text-gray-300">{ label }</span>
		<button
			type="button"
			class={ ruleToggleBtnClasses(enabled) }
			role="switch"
			aria-checked={ boolAttr(enabled) }
			aria-label={ "Toggle " + label }
			data-conn-id={ connID }
			data-feature={ feature }
			onclick="toggleConnectionFeature(this)"
		>
			<span class={ ruleToggleKnobClasses(enabled) }></span>
		</button>
	</div>
}

script settingsDeleteConnection(id string) {
	settingsDeleteConnection_click(id);
}

templ webhookCard(wh webhook.Webhook) {
	<div class="flex flex-col gap-2 rounded-lg border border-gray-200 dark:border-gray-700 px-4 py-3 sm:flex-row sm:items-center sm:justify-between">
		<div class="flex items-center gap-3 min-w-0">
			<div
				class={
					"h-2.5 w-2.5 shrink-0 rounded-full",
					templ.KV("bg-green-500", wh.Enabled),
					templ.KV("bg-gray-400 dark:bg-gray-500", !wh.Enabled),
				}
			></div>
			<div class="min-w-0">
				<div class="font-medium text-sm flex items-center gap-2">
					{ wh.Name }
					<span class="inline-flex items-center rounded-full bg-gray-100 dark:bg-gray-700 px-2 py-0.5 text-xs font-medium text-gray-600 dark:text-gray-300">
						{ wh.Type }
					</span>
				</div>
				<div class="text-xs text-gray-500 dark:text-gray-400">
					if len(wh.Events) > 0 {
						{ joinNames(wh.Events) }
					} else {
						All events
					}
				</div>
			</div>
		</div>
		<div class="flex items-center gap-2 shrink-0">
			<button
				type="button"
				class="text-sm px-3 py-1.5 rounded bg-blue-600 text-white hover:bg-blue-700 transition-colors"
				hx-post={ "/api/v1/webhooks/" + wh.ID + "/test" }
				hx-swap="none"
			>
				Test
			</button>
			<button
				type="button"
				class="text-sm px-3 py-1.5 rounded border border-red-300 dark:border-red-700 text-red-600 dark:text-red-400 hover:bg-red-50 dark:hover:bg-red-900/20 transition-colors"
				hx-delete={ "/api/v1/webhooks/" + wh.ID }
				hx-confirm="Delete this webhook?"
				hx-swap="none"
				hx-on::after-request="window.location.reload()"
			>
				Delete
			</button>
		</div>
	</div>
}

// profileNamingRow renders a single image type row in the active profile details.
// For builtin profiles it shows read-only text; for custom profiles it shows
// editable chips with add/remove controls.
templ profileNamingRow(label, imageType string, names []string, readOnly bool) {
	<div>
		<span class="font-medium text-gray-500 dark:text-gray-400">{ label }</span>
		if readOnly {
			<p class="mt-1">{ joinNames(names) }</p>
		} else {
			<div class="mt-1 flex flex-wrap items-center gap-1.5" data-naming-type={ imageType }>
				for _, name := range names {
					<span class="inline-flex items-center gap-1 rounded-full bg-gray-100 dark:bg-gray-700 px-2.5 py-0.5 text-xs font-medium text-gray-700 dark:text-gray-300" data-naming-chip={ name }>
						{ name }
						<button
							type="button"
							class="ml-0.5 text-gray-400 hover:text-red-500 focus:outline-none"
							aria-label={ "Remove " + name }
							onclick="this.closest('[data-naming-chip]').remove()"
						>
							&times;
						</button>
					</span>
				}
				<button
					type="button"
					class="inline-flex items-center rounded-full border border-dashed border-gray-300 dark:border-gray-600 px-2 py-0.5 text-xs text-gray-500 hover:border-gray-400 hover:text-gray-700 dark:hover:text-gray-300 focus:outline-none"
					onclick={ templ.ComponentScript{Call: "addNamingChip(this, '" + imageType + "')"} }
				>
					+ Add
				</button>
			</div>
		}
	</div>
}

templ profileCard(p platform.Profile) {
	<div
		class={
			"relative rounded-lg border-2 p-4 cursor-pointer transition-colors",
			templ.KV("border-blue-500 bg-blue-50 dark:bg-blue-900/20", p.IsActive),
			templ.KV("border-gray-200 dark:border-gray-700 hover:border-gray-300 dark:hover:border-gray-600", !p.IsActive),
		}
		hx-post={ "/api/v1/platforms/" + p.ID + "/activate" }
		hx-swap="none"
		hx-on::after-request="window.location.reload()"
	>
		<div class="flex items-center justify-between">
			<div class="flex items-center gap-2">
				if logoSrcSet(p.ID) != "" {
					<img
						src={ logoSrc(p.ID) }
						srcset={ logoSrcSet(p.ID) }
						alt=""
						class="h-6 w-6 shrink-0"
						aria-hidden="true"
					/>
				} else {
					<img
						src={ logoSrc(p.ID) }
						alt=""
						class="h-6 w-6 shrink-0"
						aria-hidden="true"
					/>
				}
				<h3 class="font-semibold text-sm">{ p.Name }</h3>
			</div>
			if p.IsActive {
				<span class="inline-flex items-center rounded-full bg-blue-100 dark:bg-blue-800 px-2 py-0.5 text-xs font-medium text-blue-700 dark:text-blue-300">
					Active
				</span>
			}
		</div>
		<div class="mt-2 text-xs text-gray-500 dark:text-gray-400 space-y-1">
			<div>
				NFO:
				if p.NFOEnabled {
					<span class="text-green-600 dark:text-green-400">Enabled</span>
				} else {
					<span class="text-gray-400 dark:text-gray-500">Disabled</span>
				}
			</div>
			<div>Thumb: { joinNames(p.ImageNaming.Thumb) }</div>
			<div>Fanart: { joinNames(p.ImageNaming.Fanart) }</div>
		</div>
	</div>
}

templ ruleRow(rl rule.Rule) {
	<div class="py-4 space-y-2">
		<div class="flex items-center justify-between gap-4">
			<div class="flex-1 min-w-0">
				<div class="flex items-center gap-2">
					<span class="font-medium text-sm">{ rl.Name }</span>
					@severityBadge(rl.Config.Severity)
				</div>
				<p class="text-xs text-gray-500 dark:text-gray-400 mt-0.5">{ rl.Description }</p>
			</div>
			<div class="flex items-center gap-3 shrink-0">
				<select
					class="text-xs rounded border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 px-2 py-1 focus:outline-none focus:ring-2 focus:ring-blue-500"
					aria-label={ "Automation mode for " + rl.Name }
					data-rule-id={ rl.ID }
					onchange="patchRule(this.dataset.ruleId, {automation_mode: this.value})"
					disabled?={ !rl.Enabled }
				>
					<option value="auto" selected?={ rl.AutomationMode == "auto" || rl.AutomationMode == "" }>Auto-fix</option>
					<option value="notify" selected?={ rl.AutomationMode == "notify" }>Notify only</option>
					<option value="disabled" selected?={ rl.AutomationMode == "disabled" }>Disabled</option>
				</select>
				<button
					type="button"
					class={ ruleToggleBtnClasses(rl.Enabled) }
					role="switch"
					aria-checked={ boolAttr(rl.Enabled) }
					data-rule-id={ rl.ID }
					onclick="toggleRuleEnabled(this)"
					aria-label={ "Enable " + rl.Name }
				>
					<span class={ ruleToggleKnobClasses(rl.Enabled) }></span>
				</button>
			</div>
		</div>
		if ruleHasConfig(rl.ID) {
			<div>
				<button
					type="button"
					class="text-xs text-blue-600 dark:text-blue-400 hover:underline"
					onclick={ toggleRuleConfig(rl.ID) }
				>Configure</button>
				<div id={ "rule-cfg-" + rl.ID } class="hidden mt-2">
					@ruleConfigForm(rl)
				</div>
			</div>
		}
	</div>
}

templ severityBadge(severity string) {
	{{ cls := severityBadgeClasses(severity) }}
	<span class={ "inline-flex items-center rounded-full px-2 py-0.5 text-xs font-medium", cls }>
		{ severity }
	</span>
}

templ ruleConfigForm(rl rule.Rule) {
	<form
		class="grid grid-cols-2 gap-3 sm:grid-cols-3 items-end"
		data-rule-id={ rl.ID }
		onsubmit="handleRuleConfigSubmit(event)"
	>
		if rl.ID == "thumb_min_res" || rl.ID == "fanart_min_res" || rl.ID == "banner_min_res" || rl.ID == "logo_min_res" {
			<div class="col-span-full">
				<label class="block">
					<span class="text-xs text-gray-600 dark:text-gray-400">Resolution preset</span>
					<select
						class="mt-0.5 w-full rounded border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 px-2 py-1 text-sm focus:outline-none focus:ring-1 focus:ring-blue-500"
						onchange="applyResPreset(this)"
					>
						@resolutionPresetOptions(rl)
					</select>
				</label>
			</div>
		}
		if rl.ID == "thumb_min_res" || rl.ID == "fanart_min_res" || rl.ID == "banner_min_res" {
			<label class="block">
				<span class="text-xs text-gray-600 dark:text-gray-400">Min width (px)</span>
				<input
					type="number"
					name="min_width"
					min="1"
					value={ intOrDefault(rl.Config.MinWidth, defaultMinWidth(rl.ID)) }
					class="mt-0.5 w-full rounded border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 px-2 py-1 text-sm focus:outline-none focus:ring-1 focus:ring-blue-500"
				/>
			</label>
			<label class="block">
				<span class="text-xs text-gray-600 dark:text-gray-400">Min height (px)</span>
				<input
					type="number"
					name="min_height"
					min="1"
					value={ intOrDefault(rl.Config.MinHeight, defaultMinHeight(rl.ID)) }
					class="mt-0.5 w-full rounded border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 px-2 py-1 text-sm focus:outline-none focus:ring-1 focus:ring-blue-500"
				/>
			</label>
		}
		if rl.ID == "logo_min_res" {
			<label class="block">
				<span class="text-xs text-gray-600 dark:text-gray-400">Min width (px)</span>
				<input
					type="number"
					name="min_width"
					min="1"
					value={ intOrDefault(rl.Config.MinWidth, 400) }
					class="mt-0.5 w-full rounded border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 px-2 py-1 text-sm focus:outline-none focus:ring-1 focus:ring-blue-500"
				/>
			</label>
		}
		if rl.ID == "thumb_square" || rl.ID == "fanart_aspect" {
			<div class="col-span-full">
				<label class="block">
					<span class="text-xs text-gray-600 dark:text-gray-400">Aspect ratio preset</span>
					<select
						class="mt-0.5 w-full rounded border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 px-2 py-1 text-sm focus:outline-none focus:ring-1 focus:ring-blue-500"
						onchange="applyAspectPreset(this)"
					>
						@aspectPresetOptions(rl)
					</select>
				</label>
			</div>
			<label class="block">
				<span class="text-xs text-gray-600 dark:text-gray-400">Aspect ratio (decimal)</span>
				<input
					type="number"
					name="aspect_ratio"
					step="0.001"
					min="0.1"
					value={ floatOrDefault(rl.Config.AspectRatio, defaultAspectRatio(rl.ID)) }
					class="mt-0.5 w-full rounded border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 px-2 py-1 text-sm focus:outline-none focus:ring-1 focus:ring-blue-500"
				/>
			</label>
			<label class="block">
				<span class="text-xs text-gray-600 dark:text-gray-400">Tolerance (e.g. 0.1)</span>
				<input
					type="number"
					name="tolerance"
					step="0.01"
					min="0"
					max="0.5"
					value={ floatOrDefault(rl.Config.Tolerance, 0.1) }
					class="mt-0.5 w-full rounded border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 px-2 py-1 text-sm focus:outline-none focus:ring-1 focus:ring-blue-500"
				/>
			</label>
		}
		if rl.ID == "bio_exists" {
			<label class="block">
				<span class="text-xs text-gray-600 dark:text-gray-400">Min length (chars)</span>
				<input
					type="number"
					name="min_length"
					min="1"
					value={ intOrDefault(rl.Config.MinLength, 10) }
					class="mt-0.5 w-full rounded border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 px-2 py-1 text-sm focus:outline-none focus:ring-1 focus:ring-blue-500"
				/>
			</label>
		}
		<label class="block">
			<span class="text-xs text-gray-600 dark:text-gray-400">Severity</span>
			<select
				name="severity"
				class="mt-0.5 w-full rounded border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 px-2 py-1 text-sm focus:outline-none focus:ring-1 focus:ring-blue-500"
			>
				<option value="error" selected?={ rl.Config.Severity == "error" }>Error</option>
				<option value="warning" selected?={ rl.Config.Severity == "warning" }>Warning</option>
				<option value="info" selected?={ rl.Config.Severity == "info" }>Info</option>
			</select>
		</label>
		<div class="flex gap-2 col-span-full">
			<button
				type="submit"
				class="text-xs px-3 py-1.5 rounded bg-green-600 text-white hover:bg-green-700 transition-colors"
			>
				Save
			</button>
			<button
				type="button"
				class="text-xs px-3 py-1.5 rounded border border-gray-300 dark:border-gray-600 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors"
				onclick={ toggleRuleConfig(rl.ID) }
			>
				Cancel
			</button>
		</div>
	</form>
}

templ resolutionPresetOptions(rl rule.Rule) {
	if rl.ID == "fanart_min_res" {
		{{ key := fanartResPresetKey(rl.Config.MinWidth, rl.Config.MinHeight) }}
		<option value="">-- select preset --</option>
		<option value="1280,720" selected?={ key == "720p" }>720p HD (1280x720)</option>
		<option value="1920,1080" selected?={ key == "1080p" }>1080p Full HD (1920x1080)</option>
		<option value="2560,1440" selected?={ key == "1440p" }>1440p QHD (2560x1440)</option>
		<option value="3840,2160" selected?={ key == "4k" }>4K UHD (3840x2160)</option>
		<option value="custom" selected?={ key == "custom" }>Custom</option>
	}
	if rl.ID == "thumb_min_res" {
		{{ key := thumbResPresetKey(rl.Config.MinWidth, rl.Config.MinHeight) }}
		<option value="">-- select preset --</option>
		<option value="500,500" selected?={ key == "std" }>Standard (500x500)</option>
		<option value="1000,1000" selected?={ key == "hd" }>HD (1000x1000)</option>
		<option value="2000,2000" selected?={ key == "ultra" }>Ultra (2000x2000)</option>
		<option value="custom" selected?={ key == "custom" }>Custom</option>
	}
	if rl.ID == "banner_min_res" {
		{{ key := bannerResPresetKey(rl.Config.MinWidth, rl.Config.MinHeight) }}
		<option value="">-- select preset --</option>
		<option value="758,140" selected?={ key == "kodi" }>Kodi standard (758x140)</option>
		<option value="1000,185" selected?={ key == "wide" }>Wide (1000x185)</option>
		<option value="custom" selected?={ key == "custom" }>Custom</option>
	}
	if rl.ID == "logo_min_res" {
		{{ key := logoWidthPresetKey(rl.Config.MinWidth) }}
		<option value="">-- select preset --</option>
		<option value="400" selected?={ key == "std" }>Standard (400px)</option>
		<option value="800" selected?={ key == "large" }>Large (800px)</option>
		<option value="custom" selected?={ key == "custom" }>Custom</option>
	}
}

templ aspectPresetOptions(rl rule.Rule) {
	if rl.ID == "fanart_aspect" {
		{{ key := fanartAspectPresetKey(rl.Config.AspectRatio) }}
		<option value="">-- select preset --</option>
		<option value="1.7778" selected?={ key == "16:9" }>16:9 widescreen (1.778)</option>
		<option value="1.6" selected?={ key == "16:10" }>16:10 (1.6)</option>
		<option value="2.0" selected?={ key == "2:1" }>2:1 ultra-wide (2.0)</option>
		<option value="custom" selected?={ key == "custom" }>Custom</option>
	}
	if rl.ID == "thumb_square" {
		{{ key := thumbAspectPresetKey(rl.Config.AspectRatio) }}
		<option value="">-- select preset --</option>
		<option value="1.0" selected?={ key == "1:1" }>1:1 square (1.0)</option>
		<option value="custom" selected?={ key == "custom" }>Custom</option>
	}
}

script toggleRuleConfig(ruleID string) {
	var el = document.getElementById("rule-cfg-" + ruleID);
	if (el) {
		el.classList.toggle("hidden");
	}
}

templ ruleToggleScript() {
	<script>
		function patchRule(ruleID, changes) {
			var csrfToken = document.cookie.replace(
				/(?:(?:^|.*;\s*)csrf_token\s*=\s*([^;]*).*$)|^.*$/, "$1"
			);
			fetch('/api/v1/rules/' + ruleID, {
				method: 'PUT',
				headers: {'Content-Type': 'application/json', 'X-CSRF-Token': csrfToken},
				body: JSON.stringify(changes),
				credentials: 'same-origin'
			}).then(function(r) {
				if (!r.ok && typeof showToast === 'function') {
					showToast('Failed to update rule.');
				}
			}).catch(function() {
				if (typeof showToast === 'function') {
					showToast('Network error updating rule.');
				}
			});
		}

		function toggleRuleEnabled(btn) {
			var ruleID = btn.dataset.ruleId;
			var isOn = btn.getAttribute('aria-checked') === 'true';
			var newVal = !isOn;
			patchRule(ruleID, {enabled: newVal});
			// Optimistic update
			btn.setAttribute('aria-checked', String(newVal));
			var knob = btn.querySelector('span');
			var row = btn.closest('.py-4');
			var sel = row ? row.querySelector('select[data-rule-id]') : null;
			if (newVal) {
				btn.classList.remove('bg-gray-200', 'dark:bg-gray-600');
				btn.classList.add('bg-blue-600');
				knob.classList.remove('translate-x-0');
				knob.classList.add('translate-x-5');
				if (sel) sel.disabled = false;
			} else {
				btn.classList.remove('bg-blue-600');
				btn.classList.add('bg-gray-200', 'dark:bg-gray-600');
				knob.classList.remove('translate-x-5');
				knob.classList.add('translate-x-0');
				if (sel) sel.disabled = true;
			}
		}

		function handleRuleConfigSubmit(event) {
			event.preventDefault();
			var form = event.target;
			var ruleID = form.dataset.ruleId;
			var cfg = {};
			['min_width', 'min_height', 'aspect_ratio', 'tolerance', 'min_length'].forEach(function(f) {
				var el = form.elements[f];
				if (el && el.value !== '') cfg[f] = parseFloat(el.value);
			});
			var sev = form.elements['severity'];
			if (sev) cfg['severity'] = sev.value;
			patchRule(ruleID, {config: cfg});
			var panel = document.getElementById('rule-cfg-' + ruleID);
			if (panel) panel.classList.add('hidden');
		}

		function applyResPreset(select) {
			var val = select.value;
			if (!val || val === 'custom') return;
			var parts = val.split(',');
			var form = select.closest('form');
			var w = form.elements['min_width'];
			var h = form.elements['min_height'];
			if (w && parts[0]) w.value = parts[0];
			if (h && parts.length > 1 && parts[1]) h.value = parts[1];
		}

		function applyAspectPreset(select) {
			var val = select.value;
			if (!val || val === 'custom') return;
			var form = select.closest('form');
			var ar = form.elements['aspect_ratio'];
			if (ar) ar.value = val;
		}
	</script>
}
