# Copilot PR Review Instructions

## Project summary

Stillwater is a self-hosted web application for managing artist/composer
metadata (NFO files) and images across media platforms. Built with Go 1.26+,
net/http stdlib routing, SQLite (modernc.org/sqlite, no CGO), HTMX, Templ
templates, and Tailwind CSS. Structured logging via slog.

## Focus areas (review these carefully)

- Security vulnerabilities: SQL injection, XSS, SSRF, command injection, path traversal
- Correctness bugs: logic errors, off-by-one, nil/zero-value mishandling, race conditions
- Data loss risks: missing error checks on file writes, unchecked database operations
- API contract violations: wrong HTTP status codes, missing validation at boundaries

## Go conventions

- Prefer `fmt.Errorf("...: %w", err)` for error wrapping
- Prefer `slog` over the `log` package
- Prefer table-driven tests with `t.Run` subtests
- Prefer `context.Context` as the first parameter
- All exported functions and types require doc comments

## Files to skip

- `*_templ.go` -- generated by templ; review the `.templ` source instead
- `go.sum` -- auto-generated dependency lockfile
- `web/static/js/vendor/` -- vendored third-party JS, not our code
- `internal/database/migrations/*.sql` -- SQL migrations are append-only and reviewed manually

## Known patterns -- do not flag

- SSRF protection uses a custom `http.Transport` with `DialContext` that validates
  resolved IPs. CodeQL `go/request-forgery` alerts on `client.Get()` calls using
  this transport are false positives.
- The `hxValsJSON` helper uses `json.Marshal` for all `hx-vals` attributes. This
  is the project's standard pattern for safe JSON construction in templates.
- `//nolint` directives in test files are intentional.
- `#nosec` annotations have been reviewed and are intentional.

## Lower priority (mention only if clearly wrong)

- Do not comment on test function names, test comment wording, or test variable naming
- Style preferences that do not affect correctness
- Suggestions to refactor working code for hypothetical testability improvements
