openapi: 3.1.0
info:
  title: Stillwater API
  version: 0.10.0
  description: Artist metadata and image management for Emby, Jellyfin, and Kodi.
  license:
    name: GPL-3.0
    url: https://www.gnu.org/licenses/gpl-3.0.html
servers:
  - url: http://localhost:1973/api/v1
    description: Local development
security:
  - cookieAuth: []
components:
  securitySchemes:
    cookieAuth:
      type: apiKey
      in: cookie
      name: session
  schemas:
    Error:
      type: object
      properties:
        error:
          type: string
      required: [error]
    Status:
      type: object
      properties:
        status:
          type: string
    ConnectionResponse:
      type: object
      properties:
        id:
          type: string
        name:
          type: string
        type:
          type: string
          enum: [emby, jellyfin, lidarr]
        url:
          type: string
        has_key:
          type: boolean
        enabled:
          type: boolean
        status:
          type: string
        status_message:
          type: string
        last_checked_at:
          type: string
          format: date-time
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
    Webhook:
      type: object
      properties:
        id:
          type: string
        name:
          type: string
        url:
          type: string
        type:
          type: string
        events:
          type: array
          items:
            type: string
        enabled:
          type: boolean
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
    HealthSummary:
      type: object
      properties:
        score:
          type: number
        total_artists:
          type: integer
        compliant_artists:
          type: integer
        missing_nfo:
          type: integer
        missing_thumb:
          type: integer
        missing_fanart:
          type: integer
        missing_mbid:
          type: integer
        top_violations:
          type: array
          items:
            type: object
            properties:
              rule_id:
                type: string
              rule_name:
                type: string
              count:
                type: integer
              severity:
                type: string
    BackupInfo:
      type: object
      properties:
        filename:
          type: string
        size:
          type: integer
        created_at:
          type: string
          format: date-time

paths:
  /health:
    get:
      tags: [Health]
      summary: Health check
      security: []
      operationId: getHealth
      responses:
        "200":
          description: Service is healthy
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: ok
                  version:
                    type: string
                  commit:
                    type: string
                  time:
                    type: string
                    format: date-time

  /auth/login:
    post:
      tags: [Auth]
      summary: Log in
      security: []
      operationId: login
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                username:
                  type: string
                password:
                  type: string
              required: [username, password]
      responses:
        "200":
          description: Login successful, session cookie set
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Status"
        "401":
          description: Invalid credentials
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /auth/setup:
    post:
      tags: [Auth]
      summary: Create initial admin account
      security: []
      operationId: setup
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                username:
                  type: string
                password:
                  type: string
                  minLength: 8
              required: [username, password]
      responses:
        "201":
          description: Admin account created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Status"
        "409":
          description: Admin account already exists
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /auth/logout:
    post:
      tags: [Auth]
      summary: Log out
      operationId: logout
      responses:
        "200":
          description: Logged out
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Status"

  /auth/me:
    get:
      tags: [Auth]
      summary: Get current user
      operationId: getMe
      responses:
        "200":
          description: Current user info
          content:
            application/json:
              schema:
                type: object
                properties:
                  user_id:
                    type: string
        "401":
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /artists:
    get:
      tags: [Artists]
      summary: List artists
      operationId: listArtists
      parameters:
        - name: page
          in: query
          schema:
            type: integer
            default: 1
        - name: page_size
          in: query
          schema:
            type: integer
            default: 50
        - name: sort
          in: query
          schema:
            type: string
        - name: order
          in: query
          schema:
            type: string
            enum: [asc, desc]
        - name: search
          in: query
          schema:
            type: string
        - name: filter
          in: query
          schema:
            type: string
      responses:
        "200":
          description: Paginated artist list
          content:
            application/json:
              schema:
                type: object
                properties:
                  artists:
                    type: array
                    items:
                      type: object
                  total:
                    type: integer
                  page:
                    type: integer
                  page_size:
                    type: integer

  /artists/duplicates:
    get:
      tags: [Artists]
      summary: Find duplicate artists
      operationId: getDuplicates
      responses:
        "200":
          description: List of duplicate groups
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object

  /artists/{id}:
    get:
      tags: [Artists]
      summary: Get artist details
      operationId: getArtist
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Artist with band members
          content:
            application/json:
              schema:
                type: object
                properties:
                  artist:
                    type: object
                  members:
                    type: array
                    items:
                      type: object
        "404":
          description: Artist not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /artists/{id}/health:
    get:
      tags: [Artists, Rules]
      summary: Evaluate artist health
      operationId: evaluateArtistHealth
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Health evaluation result
          content:
            application/json:
              schema:
                type: object

  /artists/{id}/aliases:
    get:
      tags: [Aliases]
      summary: List artist aliases
      operationId: listAliases
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: List of aliases
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  properties:
                    id:
                      type: string
                    alias:
                      type: string
                    source:
                      type: string
    post:
      tags: [Aliases]
      summary: Add alias to artist
      operationId: addAlias
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                alias:
                  type: string
                source:
                  type: string
              required: [alias]
      responses:
        "201":
          description: Alias created
          content:
            application/json:
              schema:
                type: object

  /artists/{id}/aliases/{aliasId}:
    delete:
      tags: [Aliases]
      summary: Remove alias
      operationId: removeAlias
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
        - name: aliasId
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Alias deleted
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Status"

  /artists/{id}/images/upload:
    post:
      tags: [Images]
      summary: Upload image file
      operationId: uploadImage
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              properties:
                file:
                  type: string
                  format: binary
                type:
                  type: string
                  enum: [thumb, fanart, logo, banner]
              required: [file, type]
      responses:
        "200":
          description: Image saved
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                  saved:
                    type: array
                    items:
                      type: string
                  type:
                    type: string
        "413":
          description: File exceeds 25MB limit
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /artists/{id}/images/fetch:
    post:
      tags: [Images]
      summary: Fetch image from URL
      operationId: fetchImage
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                url:
                  type: string
                  format: uri
                type:
                  type: string
                  enum: [thumb, fanart, logo, banner]
              required: [url, type]
      responses:
        "200":
          description: Image fetched and saved
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                  saved:
                    type: array
                    items:
                      type: string
                  type:
                    type: string

  /artists/{id}/images/search:
    get:
      tags: [Images]
      summary: Search providers for images
      operationId: searchImages
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
        - name: type
          in: query
          schema:
            type: string
            enum: [thumb, fanart, logo, banner]
      responses:
        "200":
          description: Image search results
          content:
            application/json:
              schema:
                type: object
                properties:
                  images:
                    type: array
                    items:
                      type: object
                  errors:
                    type: array
                    items:
                      type: string

  /artists/{id}/images/crop:
    post:
      tags: [Images]
      summary: Crop and save image
      operationId: cropImage
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                image_data:
                  type: string
                  description: Base64-encoded image data
                type:
                  type: string
                  enum: [thumb, fanart, logo, banner]
                x:
                  type: integer
                y:
                  type: integer
                width:
                  type: integer
                height:
                  type: integer
              required: [image_data, type]
      responses:
        "200":
          description: Image cropped and saved
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                  saved:
                    type: array
                    items:
                      type: string
                  type:
                    type: string

  /artists/{id}/nfo/diff:
    get:
      tags: [NFO]
      summary: Get NFO field-level diff
      operationId: getNFODiff
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
        - name: compare_to
          in: query
          description: Snapshot ID to compare against (defaults to latest)
          schema:
            type: string
      responses:
        "200":
          description: NFO diff result
          content:
            application/json:
              schema:
                type: object

  /artists/{id}/nfo/conflict:
    get:
      tags: [NFO]
      summary: Check for external NFO modifications
      operationId: checkNFOConflict
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Conflict check result
          content:
            application/json:
              schema:
                type: object
                properties:
                  has_conflict:
                    type: boolean
                  reason:
                    type: string
                  external_writer:
                    type: string

  /artists/{id}/nfo/snapshots:
    get:
      tags: [NFO]
      summary: List NFO snapshots
      operationId: listNFOSnapshots
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: List of snapshots
          content:
            application/json:
              schema:
                type: object
                properties:
                  snapshots:
                    type: array
                    items:
                      type: object

  /artists/{id}/nfo/snapshots/{snapshotId}/restore:
    post:
      tags: [NFO]
      summary: Restore NFO from snapshot
      operationId: restoreNFOSnapshot
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
        - name: snapshotId
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: NFO restored
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Status"

  /artists/{id}/push:
    post:
      tags: [Push]
      summary: Push metadata to platform
      operationId: pushMetadata
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                connection_id:
                  type: string
                platform_artist_id:
                  type: string
              required: [connection_id, platform_artist_id]
      responses:
        "200":
          description: Metadata pushed
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Status"

  /platforms:
    get:
      tags: [Platforms]
      summary: List platform profiles
      operationId: listPlatforms
      responses:
        "200":
          description: List of platform profiles
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
    post:
      tags: [Platforms]
      summary: Create platform profile
      operationId: createPlatform
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  type: string
                nfo_enabled:
                  type: boolean
                nfo_format:
                  type: string
                  enum: [kodi, jellyfin]
                image_naming:
                  type: object
              required: [name]
      responses:
        "201":
          description: Platform created
          content:
            application/json:
              schema:
                type: object

  /platforms/{id}:
    get:
      tags: [Platforms]
      summary: Get platform profile
      operationId: getPlatform
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Platform profile
          content:
            application/json:
              schema:
                type: object
        "404":
          description: Not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
    put:
      tags: [Platforms]
      summary: Update platform profile
      operationId: updatePlatform
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  type: string
                nfo_enabled:
                  type: boolean
                nfo_format:
                  type: string
                image_naming:
                  type: object
      responses:
        "200":
          description: Platform updated
          content:
            application/json:
              schema:
                type: object
    delete:
      tags: [Platforms]
      summary: Delete platform profile
      operationId: deletePlatform
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Deleted
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Status"

  /platforms/{id}/activate:
    post:
      tags: [Platforms]
      summary: Set platform as active
      operationId: activatePlatform
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Platform activated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Status"

  /connections:
    get:
      tags: [Connections]
      summary: List connections
      operationId: listConnections
      responses:
        "200":
          description: List of connections (API keys excluded)
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/ConnectionResponse"
    post:
      tags: [Connections]
      summary: Create connection
      operationId: createConnection
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  type: string
                type:
                  type: string
                  enum: [emby, jellyfin, lidarr]
                url:
                  type: string
                api_key:
                  type: string
                enabled:
                  type: boolean
              required: [name, type, url]
      responses:
        "201":
          description: Connection created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ConnectionResponse"

  /connections/{id}:
    get:
      tags: [Connections]
      summary: Get connection
      operationId: getConnection
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Connection details
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ConnectionResponse"
        "404":
          description: Not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
    put:
      tags: [Connections]
      summary: Update connection
      operationId: updateConnection
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  type: string
                type:
                  type: string
                url:
                  type: string
                api_key:
                  type: string
                enabled:
                  type: boolean
      responses:
        "200":
          description: Connection updated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ConnectionResponse"
    delete:
      tags: [Connections]
      summary: Delete connection
      operationId: deleteConnection
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Deleted
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Status"

  /connections/{id}/test:
    post:
      tags: [Connections]
      summary: Test connection
      operationId: testConnection
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Test result
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    enum: [ok, error]
                  message:
                    type: string

  /providers:
    get:
      tags: [Providers]
      summary: List providers and API key status
      operationId: listProviders
      responses:
        "200":
          description: Provider list
          content:
            application/json:
              schema:
                type: object
                properties:
                  providers:
                    type: array
                    items:
                      type: object

  /providers/{name}/key:
    put:
      tags: [Providers]
      summary: Set provider API key
      operationId: setProviderKey
      parameters:
        - name: name
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                api_key:
                  type: string
              required: [api_key]
      responses:
        "200":
          description: Key saved
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Status"
    delete:
      tags: [Providers]
      summary: Delete provider API key
      operationId: deleteProviderKey
      parameters:
        - name: name
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Key deleted
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Status"

  /providers/{name}/test:
    post:
      tags: [Providers]
      summary: Test provider connection
      operationId: testProvider
      parameters:
        - name: name
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Test result
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    enum: [ok, error]
                  error:
                    type: string

  /providers/priorities:
    get:
      tags: [Providers]
      summary: Get provider priorities
      operationId: getPriorities
      responses:
        "200":
          description: Priority configuration
          content:
            application/json:
              schema:
                type: object
                properties:
                  priorities:
                    type: array
                    items:
                      type: object
    put:
      tags: [Providers]
      summary: Set provider priorities
      operationId: setPriorities
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                priorities:
                  type: array
                  items:
                    type: object
                    properties:
                      field:
                        type: string
                      providers:
                        type: array
                        items:
                          type: string
              required: [priorities]
      responses:
        "200":
          description: Priorities saved
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Status"

  /providers/search:
    post:
      tags: [Providers]
      summary: Search providers for artist
      operationId: providerSearch
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  type: string
              required: [name]
      responses:
        "200":
          description: Search results
          content:
            application/json:
              schema:
                type: object
                properties:
                  results:
                    type: array
                    items:
                      type: object

  /providers/fetch:
    post:
      tags: [Providers]
      summary: Fetch metadata from providers
      operationId: providerFetch
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                mbid:
                  type: string
                name:
                  type: string
      responses:
        "200":
          description: Fetched metadata
          content:
            application/json:
              schema:
                type: object

  /rules:
    get:
      tags: [Rules]
      summary: List rules
      operationId: listRules
      responses:
        "200":
          description: List of rules
          content:
            application/json:
              schema:
                type: object
                properties:
                  rules:
                    type: array
                    items:
                      type: object

  /rules/{id}:
    put:
      tags: [Rules]
      summary: Update rule
      operationId: updateRule
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                enabled:
                  type: boolean
                config:
                  type: object
      responses:
        "200":
          description: Rule updated
          content:
            application/json:
              schema:
                type: object

  /rules/{id}/run:
    post:
      tags: [Rules]
      summary: Run single rule against all artists
      operationId: runRule
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Rule execution result
          content:
            application/json:
              schema:
                type: object

  /rules/run-all:
    post:
      tags: [Rules]
      summary: Run all enabled rules
      operationId: runAllRules
      responses:
        "200":
          description: Execution result
          content:
            application/json:
              schema:
                type: object

  /rules/classical-mode:
    get:
      tags: [Rules]
      summary: Get classical music handling mode
      operationId: getClassicalMode
      responses:
        "200":
          description: Current mode
          content:
            application/json:
              schema:
                type: object
                properties:
                  mode:
                    type: string
                    enum: [skip, composer, performer]
    put:
      tags: [Rules]
      summary: Set classical music handling mode
      operationId: setClassicalMode
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                mode:
                  type: string
                  enum: [skip, composer, performer]
              required: [mode]
      responses:
        "200":
          description: Mode updated
          content:
            application/json:
              schema:
                type: object
                properties:
                  mode:
                    type: string

  /bulk/fetch-metadata:
    post:
      tags: [Bulk Operations]
      summary: Start bulk metadata fetch
      operationId: bulkFetchMetadata
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                mode:
                  type: string
                  enum: [prompt_no_match, yolo, auto_exact, auto_similar]
                  default: prompt_no_match
      responses:
        "202":
          description: Job started
          content:
            application/json:
              schema:
                type: object
        "409":
          description: Another job is already running
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /bulk/fetch-images:
    post:
      tags: [Bulk Operations]
      summary: Start bulk image fetch
      operationId: bulkFetchImages
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                mode:
                  type: string
                  default: prompt_no_match
      responses:
        "202":
          description: Job started
          content:
            application/json:
              schema:
                type: object

  /bulk/jobs:
    get:
      tags: [Bulk Operations]
      summary: List recent bulk jobs
      operationId: listBulkJobs
      responses:
        "200":
          description: Recent jobs (last 20)
          content:
            application/json:
              schema:
                type: object
                properties:
                  jobs:
                    type: array
                    items:
                      type: object

  /bulk/jobs/{id}:
    get:
      tags: [Bulk Operations]
      summary: Get bulk job details
      operationId: getBulkJob
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Job with items
          content:
            application/json:
              schema:
                type: object
                properties:
                  job:
                    type: object
                  items:
                    type: array
                    items:
                      type: object

  /bulk/jobs/{id}/cancel:
    post:
      tags: [Bulk Operations]
      summary: Cancel running bulk job
      operationId: cancelBulkJob
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Job canceling
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Status"

  /reports/health:
    get:
      tags: [Reports]
      summary: Get library health summary
      operationId: getHealthReport
      responses:
        "200":
          description: Health summary
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/HealthSummary"

  /reports/health/history:
    get:
      tags: [Reports]
      summary: Get health history for charting
      operationId: getHealthHistory
      parameters:
        - name: from
          in: query
          schema:
            type: string
            format: date
        - name: to
          in: query
          schema:
            type: string
            format: date
      responses:
        "200":
          description: Health history
          content:
            application/json:
              schema:
                type: object
                properties:
                  history:
                    type: array
                    items:
                      type: object

  /reports/compliance:
    get:
      tags: [Reports]
      summary: Get compliance report
      operationId: getComplianceReport
      parameters:
        - name: page
          in: query
          schema:
            type: integer
            default: 1
        - name: page_size
          in: query
          schema:
            type: integer
            default: 50
        - name: search
          in: query
          schema:
            type: string
        - name: filter
          in: query
          schema:
            type: string
        - name: status
          in: query
          schema:
            type: string
            enum: [compliant, non_compliant]
      responses:
        "200":
          description: Paginated compliance report
          content:
            application/json:
              schema:
                type: object
                properties:
                  rows:
                    type: array
                    items:
                      type: object
                  total:
                    type: integer
                  page:
                    type: integer
                  page_size:
                    type: integer

  /webhooks:
    get:
      tags: [Webhooks]
      summary: List webhooks
      operationId: listWebhooks
      responses:
        "200":
          description: List of webhooks
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Webhook"
    post:
      tags: [Webhooks]
      summary: Create webhook
      operationId: createWebhook
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  type: string
                url:
                  type: string
                type:
                  type: string
                events:
                  type: array
                  items:
                    type: string
                enabled:
                  type: boolean
              required: [name, url]
      responses:
        "201":
          description: Webhook created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Webhook"

  /webhooks/{id}:
    get:
      tags: [Webhooks]
      summary: Get webhook
      operationId: getWebhook
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Webhook details
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Webhook"
    put:
      tags: [Webhooks]
      summary: Update webhook
      operationId: updateWebhook
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  type: string
                url:
                  type: string
                type:
                  type: string
                events:
                  type: array
                  items:
                    type: string
                enabled:
                  type: boolean
      responses:
        "200":
          description: Webhook updated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Webhook"
    delete:
      tags: [Webhooks]
      summary: Delete webhook
      operationId: deleteWebhook
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Deleted
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Status"

  /webhooks/{id}/test:
    post:
      tags: [Webhooks]
      summary: Send test webhook event
      operationId: testWebhook
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Test event sent
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Status"

  /settings:
    get:
      tags: [Settings]
      summary: Get all settings
      operationId: getSettings
      responses:
        "200":
          description: Key-value settings map
          content:
            application/json:
              schema:
                type: object
                additionalProperties:
                  type: string
    put:
      tags: [Settings]
      summary: Update settings
      operationId: updateSettings
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              additionalProperties:
                type: string
      responses:
        "200":
          description: Settings updated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Status"

  /settings/backup:
    post:
      tags: [Backup]
      summary: Create database backup
      operationId: createBackup
      responses:
        "200":
          description: Backup info
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/BackupInfo"

  /settings/backup/history:
    get:
      tags: [Backup]
      summary: List backup files
      operationId: listBackups
      responses:
        "200":
          description: List of backups
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/BackupInfo"

  /settings/backup/{filename}:
    get:
      tags: [Backup]
      summary: Download backup file
      operationId: downloadBackup
      parameters:
        - name: filename
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Backup file download
          content:
            application/octet-stream:
              schema:
                type: string
                format: binary
    delete:
      tags: [Backup]
      summary: Delete a backup file
      operationId: deleteBackup
      parameters:
        - name: filename
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Backup deleted
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Status"
        "400":
          description: Invalid filename
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "404":
          description: Backup not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /scanner/run:
    post:
      tags: [Scanner]
      summary: Trigger filesystem scan
      operationId: runScanner
      responses:
        "202":
          description: Scan started
          content:
            application/json:
              schema:
                type: object
        "409":
          description: Scan already in progress
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /scanner/status:
    get:
      tags: [Scanner]
      summary: Get scan status
      operationId: getScannerStatus
      responses:
        "200":
          description: Current or last scan status
          content:
            application/json:
              schema:
                type: object
